<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card mt-4">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Edit Device</h5>
        </div>
        <div class="card-body">
          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" style="text-align:center;">
              <%= error %>
            </div>
          <% } %>
          <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success" style="text-align:center;">
              <%= success %>
            </div>
          <% } %>
          <form action="/device/device/<%= device.id %>?_method=PUT" method="POST">
            <div class="mb-3">
              <label class="form-label">Device Type <span class="text-danger">*</span></label>
              <select id="device-type-select" name="device_type_id" class="form-select form-select-sm select2" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">IP Address(es) <span class="text-danger">*</span></label>
              <select id="ip-select" name="ip_addresses[]" class="form-control" multiple required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Device Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" id="deviceName" name="name" value="<%= device.name %>" placeholder="Device Name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Platform (OS)</label>
              <select id="platform-select" name="platform_id" class="form-select form-select-sm select2"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Location</label>
              <select name="location" class="form-select form-select-sm">
                <option value="">-- Select location --</option>
                <% if (locationOptions && Array.isArray(locationOptions)) { locationOptions.forEach(function(opt) { %>
                  <option value="<%= opt.value %>" <%= device.location === opt.value ? 'selected' : '' %>><%= opt.label %></option>
                <% }) } %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Serial</label>
              <input type="text" class="form-control form-control-sm" name="serial" value="<%= device.serial_number %>" placeholder="Serial">
            </div>
            <div class="mb-3">
              <label class="form-label">Management</label>
              <input type="text" class="form-control form-control-sm" name="management" value="<%= device.management_address %>" placeholder="Management">
              <div class="form-text text-muted">You can enter multiple values separated by commas (e.g., 192.168.1.1, 192.168.1.2)</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Manufacturer</label>
              <input type="text" class="form-control form-control-sm" name="manufacturer" value="<%= device.manufacturer %>" placeholder="Manufacturer">
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control form-control-sm" name="description" placeholder="Description" rows="3"><%= device.description %></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Tags</label>
              <select id="tag-select" name="tags[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Contacts</label>
              <select id="contact-select" name="contacts[]" class="form-control" multiple></select>
            </div>
            <div class="modal-footer d-flex justify-content-end gap-2" style="padding:0; background:none; border:none;">
              <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
              <a href="/device/device" class="btn btn-outline-secondary btn-sm">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="/vendor/jquery-3.6.0.min.js"></script>
<link href="/vendor/select2.min.css" rel="stylesheet" />
<link href="/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="/vendor/select2.min.js"></script>
<script src="/vendor/bootstrap.min.js"></script>
<link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css" />
<script>
  $(function() {
    $('#ip-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select IP address(es)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/network/api/ip-addresses/unassigned',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      },
      minimumInputLength: 0
    });
    $('#platform-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select platform (OS)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/device/api/platform',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#tag-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#device-type-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select device type',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/device/api/device-type',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#contact-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      multiple: true,
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    // Pre-populate selected tags if any
    <% if (selectedTags && selectedTags.length) { %>
      $.ajax({
        url: '/organize/api/tag',
        dataType: 'json',
        data: { search: '' },
        success: function(data) {
          var selected = [];
          var selectedTagIds = <%- JSON.stringify(selectedTags.map(function(t) { return t.id; })) %>;
          data.forEach(function(tag) {
            if (selectedTagIds.includes(tag.id)) {
              selected.push(tag);
            }
          });
          selected.forEach(function(tag) {
            var option = new Option(tag.text || tag.name, tag.id, true, true);
            $('#tag-select').append(option).trigger('change');
          });
        }
      });
    <% } %>
    // Pre-populate selected IPs if any
    <% if (device && device.ip_addresses && device.ip_addresses.length) { %>
      var selectedIps = <%- JSON.stringify(device.ip_addresses.map(function(ip) { return { id: ip.id, text: ip.ip_address }; })) %>;
      selectedIps.forEach(function(ip) {
        if ($('#ip-select option[value="' + ip.id + '"]').length === 0) {
          var option = new Option(ip.text, ip.id, true, true);
          $('#ip-select').append(option);
        }
      });
      $('#ip-select').val(selectedIps.map(function(ip){return String(ip.id);})).trigger('change');
    <% } %>
    // Pre-populate selected platform if any
    <% if (device && device.platform_id && device.platform_name) { %>
      var platformOption = new Option('<%= device.platform_name %>', '<%= device.platform_id %>', true, true);
      $('#platform-select').append(platformOption).trigger('change');
    <% } %>
    // Pre-populate selected device type if any
    <% if (device && device.device_type_id && device.device_type_name) { %>
      var typeOption = new Option('<%= device.device_type_name %>', '<%= device.device_type_id %>', true, true);
      $('#device-type-select').append(typeOption).trigger('change');
    <% } %>
    // Pre-populate selected contacts if any
    <% if (selectedContacts && selectedContacts.length) { %>
      var selectedContacts = <%- JSON.stringify(selectedContacts.map(function(c) { return { id: c.id, text: c.name }; })) %>;
      selectedContacts.forEach(function(contact) {
        if ($('#contact-select option[value="' + contact.id + '"]').length === 0) {
          var option = new Option(contact.text, contact.id, true, true);
          $('#contact-select').append(option);
        }
      });
      $('#contact-select').val(selectedContacts.map(function(c){return String(c.id);})).trigger('change');
    <% } %>
  });
</script>

