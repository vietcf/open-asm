<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card mt-4">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Edit Device</h5>
        </div>
        <div class="card-body">
          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" style="text-align:center;">
              <%= error %>
            </div>
          <% } %>
          <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success" style="text-align:center;">
              <%= success %>
            </div>
          <% } %>
          <form action="/device/device/update/<%= device.id %>" method="POST">
            <div class="mb-3">
              <label class="form-label">Device Type <span class="text-danger">*</span></label>
              <select id="device-type-select" name="device_type_id" class="form-select form-select-sm select2" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">IP Address(es) <span class="text-danger">*</span></label>
              <select id="ip-select" name="ip_addresses[]" class="form-select form-select-sm select2" multiple required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Device Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" id="deviceName" name="name" value="<%= device.name %>" placeholder="Device Name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Platform (OS)</label>
              <select id="platform-select" name="platform_id" class="form-select form-select-sm select2"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Location</label>
              <select name="location" class="form-select form-select-sm">
                <option value="">-- Select location --</option>
                <% if (locationOptions) { Object.keys(locationOptions).forEach(function(key) { %>
                  <option value="<%= key %>" <%= device.location === key ? 'selected' : '' %>><%= locationOptions[key] %></option>
                <% }); } %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Serial</label>
              <input type="text" class="form-control form-control-sm" name="serial" value="<%= device.serial_number %>" placeholder="Serial">
            </div>
            <div class="mb-3">
              <label class="form-label">Management</label>
              <input type="text" class="form-control form-control-sm" name="management" value="<%= device.management_address %>" placeholder="Management">
            </div>
            <div class="mb-3">
              <label class="form-label">Manufacturer</label>
              <input type="text" class="form-control form-control-sm" name="manufacturer" value="<%= device.manufacturer %>" placeholder="Manufacturer">
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control form-control-sm" name="description" placeholder="Description" rows="3"><%= device.description %></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Tags</label>
              <select id="tag-select" name="tags[]" class="form-select form-select-sm select2" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Contacts</label>
              <select id="contact-select" name="contacts[]" class="form-select form-select-sm select2" multiple></select>
            </div>
            <div class="modal-footer d-flex justify-content-end gap-2" style="padding:0; background:none; border:none;">
              <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
              <a href="/device/device" class="btn btn-outline-secondary btn-sm">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(function() {
    $('#ip-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select IP address(es)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/network/api/ip-addresses/unassigned',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      },
      minimumInputLength: 0
    });
    $('#platform-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select platform (OS)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/device/api/platform',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#tag-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#device-type-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select device type',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/device/api/device-type',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#contact-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      multiple: true,
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    // Pre-populate selected tags if any
    <% if (selectedTags && selectedTags.length) { %>
      $.ajax({
        url: '/organize/api/tag',
        dataType: 'json',
        data: { search: '' },
        success: function(data) {
          var selected = [];
          var selectedTagIds = <%- JSON.stringify(selectedTags.map(function(t) { return t.id; })) %>;
          data.forEach(function(tag) {
            if (selectedTagIds.includes(tag.id)) {
              selected.push(tag);
            }
          });
          selected.forEach(function(tag) {
            var option = new Option(tag.text || tag.name, tag.id, true, true);
            $('#tag-select').append(option).trigger('change');
          });
        }
      });
    <% } %>
    // Pre-populate selected IPs if any
    <% if (device && device.ip_addresses && device.ip_addresses.length) { %>
      var selectedIps = <%- JSON.stringify(device.ip_addresses.map(function(ip) { return { id: ip.id, text: ip.ip_address }; })) %>;
      selectedIps.forEach(function(ip) {
        if ($('#ip-select option[value="' + ip.id + '"]').length === 0) {
          var option = new Option(ip.text, ip.id, true, true);
          $('#ip-select').append(option);
        }
      });
      $('#ip-select').val(selectedIps.map(function(ip){return String(ip.id);})).trigger('change');
    <% } %>
    // Pre-populate selected platform if any
    <% if (device && device.platform_id && device.platform_name) { %>
      var platformOption = new Option('<%= device.platform_name %>', '<%= device.platform_id %>', true, true);
      $('#platform-select').append(platformOption).trigger('change');
    <% } %>
    // Pre-populate selected device type if any
    <% if (device && device.device_type_id && device.device_type_name) { %>
      var typeOption = new Option('<%= device.device_type_name %>', '<%= device.device_type_id %>', true, true);
      $('#device-type-select').append(typeOption).trigger('change');
    <% } %>
    // Pre-populate selected contacts if any
    <% if (selectedContacts && selectedContacts.length) { %>
      var selectedContacts = <%- JSON.stringify(selectedContacts.map(function(c) { return { id: c.id, text: c.name }; })) %>;
      selectedContacts.forEach(function(contact) {
        if ($('#contact-select option[value="' + contact.id + '"]').length === 0) {
          var option = new Option(contact.text, contact.id, true, true);
          $('#contact-select').append(option);
        }
      });
      $('#contact-select').val(selectedContacts.map(function(c){return String(c.id);})).trigger('change');
    <% } %>
  });
</script>
<style>
.form-label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: 500;
  color: #495057;
  text-align: left;
}
.form-control, .form-select, textarea.form-control {
  min-height: 38px;
  padding-top: 0.375rem !important;
  padding-bottom: 0.375rem !important;
  font-size: 1rem;
  box-sizing: border-box;
  border-radius: 0.375rem;
}
.form-control::placeholder, .form-select::placeholder, textarea.form-control::placeholder {
  color: #adb5bd;
  opacity: 1;
  font-style: italic;
  font-size: 1rem;
  vertical-align: middle;
  line-height: 1.5;
}
.select2-container--bootstrap-5 .select2-selection--single,
.select2-container--bootstrap-5 .select2-selection--multiple {
  min-height: 38px !important;
  padding-top: 0.375rem !important;
  padding-bottom: 0.375rem !important;
  font-size: 1rem !important;
  border-radius: 0.375rem !important;
  display: flex !important;
  align-items: center !important;
  box-sizing: border-box !important;
}
.select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered,
.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
  min-height: 38px;
  display: flex;
  align-items: center;
  font-size: 1rem;
  padding-left: 0.25rem;
}
.select2-container--bootstrap-5 .select2-selection--single .select2-selection__placeholder {
  color: #adb5bd;
  opacity: 1;
  font-style: italic;
  font-size: 1rem;
  display: flex;
  align-items: center;
  min-height: 38px;
}
.select2-container--bootstrap-5 .select2-selection--multiple .select2-search__field {
  min-height: 32px;
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
  font-size: 1rem;
}
.select2-container--bootstrap-5 .select2-selection--single,
.select2-container--bootstrap-5 .select2-selection--multiple {
  border: 1px solid #ced4da !important;
  background-color: #fff !important;
}
.select2-container--bootstrap-5 .select2-selection--single:focus,
.select2-container--bootstrap-5 .select2-selection--multiple:focus {
  border-color: #86b7fe !important;
  outline: 0 !important;
  box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25) !important;
}
</style>
