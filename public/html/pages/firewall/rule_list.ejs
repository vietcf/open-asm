<div class="container-fluid">
  <form class="input-group mb-3 justify-content-end align-items-center" role="search" method="get" action="/firewall/rule" style="margin-top: 2.5rem; margin-right: 0.5rem; max-width: 500px; margin-left: auto;">
    <input class="form-control rounded-start me-2" type="search" name="search" placeholder="Search any field (name, src, dst, service, action, status, ...)" aria-label="Search" value="<%= typeof search !== 'undefined' ? search : '' %>">
    <select class="form-select form-select-sm me-2" name="pageSize" onchange="this.form.submit()" style="width:90px;max-width:90px;">
      <% (pageSizeOptions || [5,10,15,20]).forEach(function(size) { %>
        <option value="<%= size %>" <%= pageSize == size ? 'selected' : '' %>><%= size %> / page</option>
      <% }) %>
    </select>
    <button class="btn btn-outline-secondary rounded-end" type="submit"><i class="bi bi-search"></i></button>
  </form>
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-end align-items-center">
      <% if (hasPermission && hasPermission(user, 'rule.create')) { %>
      <button type="button" class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addRuleModal">
        <i class="bi bi-plus"></i> Add Rule
      </button>
      <% } %>
      <!-- Add Rule Modal -->
      <div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addRuleModalLabel">Add Firewall Rule</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addRuleForm" action="/firewall/rule" method="POST">
                <div class="mb-3">
                  <label for="firewall_name" class="form-label">Firewall Name <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" id="firewall_name" name="firewall_name" required>
                    <option value="">-- Select Firewall Name --</option>
                    <% (firewallNameOptions || []).forEach(function(fw) { %>
                      <option value="<%= fw.value %>"><%= fw.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="rulename" class="form-label">Rule Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="rulename" name="rulename" required placeholder="Rule Name">
                </div>
                <div class="mb-3">
                  <label for="src_zone" class="form-label">Source Zone</label>
                  <input type="text" class="form-control form-control-sm" id="src_zone" name="src_zone" placeholder="Source Zone">
                </div>
                <div class="mb-3">
                  <label for="src" class="form-label">Source <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="src" name="src" required placeholder="Source">
                </div>
                <div class="mb-3">
                  <label for="src_detail" class="form-label">Source Detail</label>
                  <textarea class="form-control form-control-sm" id="src_detail" name="src_detail" rows="1" placeholder="Source Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="dst_zone" class="form-label">Destination Zone</label>
                  <input type="text" class="form-control form-control-sm" id="dst_zone" name="dst_zone" placeholder="Destination Zone">
                </div>
                <div class="mb-3">
                  <label for="dst" class="form-label">Destination <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="dst" name="dst" required placeholder="Destination">
                </div>
                <div class="mb-3">
                  <label for="dst_detail" class="form-label">Destination Detail</label>
                  <textarea class="form-control form-control-sm" id="dst_detail" name="dst_detail" rows="1" placeholder="Destination Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="services" class="form-label">Service</label>
                  <input type="text" class="form-control form-control-sm" id="services" name="services" placeholder="Service/Port">
                </div>
                <div class="mb-3">
                  <label for="application" class="form-label">Application</label>
                  <input type="text" class="form-control form-control-sm" id="application" name="application" placeholder="Application">
                </div>
                <div class="mb-3">
                  <label for="url" class="form-label">URL</label>
                  <input type="text" class="form-control form-control-sm" id="url" name="url" placeholder="URL">
                </div>
                <div class="mb-3">
                  <label for="action" class="form-label">Action <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" id="action" name="action" required>
                    <option value="">-- Select Action --</option>
                    <% (actionsOptions || []).forEach(function(act) { %>
                      <option value="<%= act.value %>"><%= act.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="status" class="form-label">Status</label>
                  <select class="form-select form-select-sm" id="status" name="status">
                    <option value="">-- No status --</option>
                    <% (statusOptions || []).forEach(function(st) { %>
                      <option value="<%= st.value %>"><%= st.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="violation_type" class="form-label">Violation Type</label>
                  <select class="form-select form-select-sm" id="violation_type" name="violation_type">
                    <option value="">-- None --</option>
                    <% (violationTypeOptions || []).forEach(function(vt) { %>
                      <option value="<%= vt.value %>" <%= typeof violation_type !== 'undefined' && violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="violation_detail" class="form-label">Violation Detail</label>
                  <textarea class="form-control form-control-sm" id="violation_detail" name="violation_detail" rows="1" placeholder="Violation Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="solution_proposal" class="form-label">Solution Proposal</label>
                  <textarea class="form-control form-control-sm" id="solution_proposal" name="solution_proposal" rows="1" placeholder="Solution Proposal"></textarea>
                </div>
                <div class="mb-3">
                  <label for="solution_confirm" class="form-label">Solution Confirm</label>
                  <textarea class="form-control form-control-sm" id="solution_confirm" name="solution_confirm" rows="1" placeholder="Solution Confirm"></textarea>
                </div>
                <div class="mb-3 position-relative">
                  <label for="ruleTags" class="form-label">Tags</label>
                  <select id="ruleTags" name="tags[]" class="form-select form-select-sm select2" multiple></select>
                </div>
                <div class="mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control form-control-sm" id="description" name="description" rows="2" placeholder="Description"></textarea>
                </div>
                <div class="modal-footer d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-sm">Add Rule</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <form action="/firewall/rule/export" method="GET" style="display:inline;" class="me-2" id="exportRuleForm">
        <input type="hidden" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>">
        <input type="hidden" name="ou_id" value="<%= typeof ou_id !== 'undefined' ? ou_id : '' %>">
        <% if (typeof tags !== 'undefined' && Array.isArray(tags)) { tags.forEach(function(t) { %>
          <input type="hidden" name="tags[]" value="<%= t %>">
        <% }) } %>
        <% if (typeof contacts !== 'undefined' && Array.isArray(contacts)) { contacts.forEach(function(c) { %>
          <input type="hidden" name="contacts[]" value="<%= c %>">
        <% }) } %>
        <input type="hidden" name="violation_type" value="<%= typeof violation_type !== 'undefined' ? violation_type : '' %>">
        <input type="hidden" name="status" value="<%= typeof status !== 'undefined' ? status : '' %>">
        <input type="hidden" name="firewall_name" value="<%= typeof firewall_name !== 'undefined' ? firewall_name : '' %>">
        <button type="submit" class="btn btn-warning btn-sm">
          <i class="bi bi-download"></i> Export
        </button>
      </form>
      <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#filterRuleModal">
        <i class="bi bi-funnel"></i> Filter
      </button>
    </div>
  </div>
  <!-- Filter Rule Modal -->
  <div class="modal fade" id="filterRuleModal" tabindex="-1" aria-labelledby="filterRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterRuleModalLabel">Filter Firewall Rules</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="get" action="/firewall/rule">
          <div class="modal-body">
            <div class="mb-3">
              <label for="filterRuleFirewallName" class="form-label">Firewall Name</label>
              <select class="form-select form-select-sm" id="filterRuleFirewallName" name="firewall_name">
                <option value="">-- All --</option>
                <% (firewallNameOptions || []).forEach(function(fw) { %>
                  <option value="<%= fw.value %>" <%= typeof firewall_name !== 'undefined' && firewall_name === fw.value ? 'selected' : '' %>><%= fw.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="mb-3">
              <label for="filterRuleOuId" class="form-label">OU (Unit)</label>
              <select id="filterRuleOuId" name="ou_id" class="form-select form-select-sm select2" style="width:100%"></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleContacts" class="form-label">Contacts</label>
              <select id="filterRuleContacts" name="contacts[]" class="form-select form-select-sm select2" multiple></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleTags" class="form-label">Tags</label>
              <select id="filterRuleTags" name="tags[]" class="form-select form-select-sm select2" multiple></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleViolationType" class="form-label">Violation Type</label>
              <select class="form-select form-select-sm" id="filterRuleViolationType" name="violation_type">
                <option value="">-- All --</option>
                <% (violationTypeOptions || []).forEach(function(vt) { %>
                  <option value="<%= vt.value %>" <%= typeof violation_type !== 'undefined' && violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="mb-3">
              <label for="filterRuleStatus" class="form-label">Status</label>
              <select class="form-select form-select-sm" id="filterRuleStatus" name="status">
                <option value="">-- All --</option>
                <% (statusOptions || []).forEach(function(st) { %>
                  <option value="<%= st.value %>" <%= typeof status !== 'undefined' && status === st.value ? 'selected' : '' %>><%= st.label %></option>
                <% }) %>
              </select>
            </div>
            <!-- Add more filter fields as needed -->
          </div>
          <div class="modal-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm">Apply Filter</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning btn-sm ms-2" id="clearAllFilterBtn">Clear All Filter</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title mb-0">Firewall Rules List</h3>
        </div>
        <div class="card-body table-responsive p-0">
          <% if (typeof error !== 'undefined' && error) { %>
            <div id="toast-error" class="toast-error alert alert-danger" style="position:absolute; left:0; right:0; top:0; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">
              <%= error %>
            </div>
            <script>setTimeout(function(){var el=document.getElementById('toast-error');if(el)el.style.display='none';},3000);</script>
          <% } %>
          <% if (typeof success !== 'undefined' && success) { %>
            <div id="toast-success" class="toast-success alert alert-success" style="position:absolute; left:0; right:0; top:40px; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">
              <%= success %>
            </div>
            <script>setTimeout(function(){var el=document.getElementById('toast-success');if(el)el.style.display='none';},3000);</script>
          <% } %>
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>#</th>
                <th>Firewall Name</th>
                <th>Rule Name</th>
                <th>Source</th>
                <th>Destination</th>
                <th>Port</th>
                <!-- <th>Protocol</th> -->
                <th>Status</th>
                <!-- <th>Created At</th> -->
                <th>OU (Unit)</th>
                <th>Violation Type</th>
                <th>Tags</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (ruleList && ruleList.length > 0) { %>
                <% ruleList.forEach(function(rule, idx) { %>
                  <tr>
                    <td><%= (page - 1) * pageSize + idx + 1 %></td>
                    <td><%= rule.firewall_name || '' %></td>
                    <td><%= rule.rulename %></td>
                    <td><%= rule.src %></td>
                    <td><%= rule.dst %></td>
                    <td><%= rule.services %></td>
                    <!-- <td><%= rule.protocol || '' %></td> -->
                    <td>
                      <% if (rule.status === 'active' || rule.status === 1) { %>
                        <span class="badge bg-success">Enabled</span>
                      <% } else { %>
                        <span class="badge bg-secondary">Disabled</span>
                      <% } %>
                    </td>
                    <!-- <td><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></td> -->
                    <td><%= rule.ou_name || '' %></td>
                    <td><%= rule.violation_type || '' %></td>
                    <td>
                      <% if (rule.tagNames && rule.tagNames.length > 0) { %>
                        <% rule.tagNames.forEach(function(tag) { %>
                          <span class="badge bg-light text-dark" style="font-size:1rem; font-weight:400; padding:0.35em 0.8em;"><%= tag %></span>
                        <% }) %>
                      <% } else { %>
                        <span class="text-muted">No tags</span>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <a href="#" class="btn btn-info btn-sm" title="Show" data-bs-toggle="modal" data-bs-target="#ruleDetailModal-<%= rule.id %>"><i class="bi bi-eye"></i></a>
                      <% if (hasPermission && hasPermission(user, 'rule.update')) { %>
                      <button type="button" class="btn btn-warning btn-sm" title="Edit" data-bs-toggle="modal" data-bs-target="#ruleEditModal-<%= rule.id %>"><i class="bi bi-pencil"></i></button>
                      <% } %>
                      <% if (hasPermission && hasPermission(user, 'rule.delete')) { %>
                      <form action="/firewall/rule/<%= rule.id %>?_method=DELETE" method="POST" style="display:inline">
                        <button type="submit" class="btn btn-danger btn-sm" title="Delete" onclick="return confirm('Are you sure you want to delete this rule?')"><i class="bi bi-trash"></i></button>
                      </form>
                      <% } %>
                    </td>
                  </tr>
                  <!-- Rule Detail Modal -->
                  <div class="modal fade" id="ruleDetailModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleDetailModalLabel-<%= rule.id %>" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content firewall-detail-modal">
                        <div class="modal-header">
                          <h5 class="modal-title" id="ruleDetailModalLabel-<%= rule.id %>">Firewall Rule Detail</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <dl class="row mb-0">
                            <dt class="col-sm-4">Rule Name</dt>
                            <dd class="col-sm-8"><%= rule.rulename %></dd>
                            <dt class="col-sm-4">Source Zone</dt>
                            <dd class="col-sm-8"><%= rule.src_zone || '' %></dd>
                            <dt class="col-sm-4">Source</dt>
                            <dd class="col-sm-8"><%= rule.src %></dd>
                            <dt class="col-sm-4">Source Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.src_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Destination Zone</dt>
                            <dd class="col-sm-8"><%= rule.dst_zone || '' %></dd>
                            <dt class="col-sm-4">Destination</dt>
                            <dd class="col-sm-8"><%= rule.dst %></dd>
                            <dt class="col-sm-4">Destination Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.dst_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Service</dt>
                            <dd class="col-sm-8"><%= rule.services || '' %></dd>
                            <dt class="col-sm-4">Application</dt>
                            <dd class="col-sm-8"><%= rule.application || '' %></dd>
                            <dt class="col-sm-4">URL</dt>
                            <dd class="col-sm-8"><%= rule.url || '' %></dd>
                            <dt class="col-sm-4">Action</dt>
                            <dd class="col-sm-8"><%= rule.action %></dd>
                            <dt class="col-sm-4">OU (Unit)</dt>
                            <dd class="col-sm-8"><%= rule.ou_name || '' %></dd>
                            <dt class="col-sm-4">Contacts</dt>
                            <dd class="col-sm-8">
                              <% if (rule.contacts && rule.contacts.length > 0) { %>
                                <% rule.contacts.forEach(function(c, i) { %>
                                  <span><%= c.name %><%= c.email ? ' (' + c.email + ')' : '' %><%= i < rule.contacts.length - 1 ? ', ' : '' %></span>
                                <% }) %>
                              <% } else { %>
                                <span class="text-muted">No contacts</span>
                              <% } %>
                            </dd>
                            <dt class="col-sm-4">Violation Type</dt>
                            <dd class="col-sm-8"><%= rule.violation_type || '' %></dd>
                            <dt class="col-sm-4">Violation Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.violation_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Solution Proposal</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_proposal || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Solution Confirm</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_confirm || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8"><%= rule.status || '' %></dd>
                            <dt class="col-sm-4">Description</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.description || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Tags</dt>
                            <dd class="col-sm-8">
                              <% if (rule.tagNames && rule.tagNames.length > 0) { %>
                                <% rule.tagNames.forEach(function(tag) { %>
                                  <span class="badge bg-light text-dark" style="font-size:1rem; font-weight:400; padding:0.35em 0.8em;"><%= tag %></span>
                                <% }) %>
                              <% } else { %>
                                <span class="text-muted">No tags</span>
                              <% } %>
                            </dd>
                            <dt class="col-sm-4">Created At</dt>
                            <dd class="col-sm-8"><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></dd>
                            <dt class="col-sm-4">Updated At</dt>
                            <dd class="col-sm-8"><%= rule.updated_at ? (rule.updated_at.toLocaleString ? rule.updated_at.toLocaleString() : rule.updated_at) : '' %></dd>
                            <dt class="col-sm-4">Updated By</dt>
                            <dd class="col-sm-8"><%= rule.updated_by || '' %></dd>
                          </dl>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Rule Edit Modal -->
                  <div class="modal fade" id="ruleEditModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleEditModalLabel-<%= rule.id %>" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="ruleEditModalLabel-<%= rule.id %>">Edit Firewall Rule</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form action="/firewall/rule/<%= rule.id %>" method="POST">
                            <div class="mb-3">
                              <label for="editFirewallName-<%= rule.id %>" class="form-label">Firewall Name <span class="text-danger">*</span></label>
                              <select class="form-select form-select-sm" id="editFirewallName-<%= rule.id %>" name="firewall_name" required>
                                <option value="">-- Select Firewall Name --</option>
                                <% (firewallNameOptions || []).forEach(function(fw) { %>
                                  <option value="<%= fw.value %>" <%= rule.firewall_name === fw.value ? 'selected' : '' %>><%= fw.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editRulename-<%= rule.id %>" class="form-label">Rule Name <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editRulename-<%= rule.id %>" name="rulename" value="<%= rule.rulename %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editSrcZone-<%= rule.id %>" class="form-label">Source Zone</label>
                              <input type="text" class="form-control form-control-sm" id="editSrcZone-<%= rule.id %>" name="src_zone" value="<%= rule.src_zone || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editSrc-<%= rule.id %>" class="form-label">Source <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editSrc-<%= rule.id %>" name="src" value="<%= rule.src %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editSrcDetail-<%= rule.id %>" class="form-label">Source Detail</label>
                              <textarea class="form-control form-control-sm" id="editSrcDetail-<%= rule.id %>" name="src_detail" rows="1"><%= rule.src_detail || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editDstZone-<%= rule.id %>" class="form-label">Destination Zone</label>
                              <input type="text" class="form-control form-control-sm" id="editDstZone-<%= rule.id %>" name="dst_zone" value="<%= rule.dst_zone || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editDst-<%= rule.id %>" class="form-label">Destination <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editDst-<%= rule.id %>" name="dst" value="<%= rule.dst %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editDstDetail-<%= rule.id %>" class="form-label">Destination Detail</label>
                              <textarea class="form-control form-control-sm" id="editDstDetail-<%= rule.id %>" name="dst_detail" rows="1"><%= rule.dst_detail || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editServices-<%= rule.id %>" class="form-label">Service</label>
                              <input type="text" class="form-control form-control-sm" id="editServices-<%= rule.id %>" name="services" value="<%= rule.services || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editApplication-<%= rule.id %>" class="form-label">Application</label>
                              <input type="text" class="form-control form-control-sm" id="editApplication-<%= rule.id %>" name="application" value="<%= rule.application || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editUrl-<%= rule.id %>" class="form-label">URL</label>
                              <input type="text" class="form-control form-control-sm" id="editUrl-<%= rule.id %>" name="url" value="<%= rule.url || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editAction-<%= rule.id %>" class="form-label">Action <span class="text-danger">*</span></label>
                              <select class="form-select form-select-sm" id="editAction-<%= rule.id %>" name="action" required>
                                <option value="">-- Select Action --</option>
                                <% (actionsOptions || []).forEach(function(act) { %>
                                  <option value="<%= act.value %>" <%= rule.action === act.value ? 'selected' : '' %>><%= act.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3 position-relative">
                              <label for="editRuleOuId-<%= rule.id %>" class="form-label">OU (Unit)</label>
                              <select id="editRuleOuId-<%= rule.id %>" name="ou_id" class="form-select form-select-sm select2" style="width:100%"></select>
                            </div>
                            <div class="mb-3">
                              <label for="editRuleContacts-<%= rule.id %>" class="form-label">Contacts</label>
                              <select id="editRuleContacts-<%= rule.id %>" name="contacts[]" class="form-select form-select-sm select2" multiple data-selected='<%- JSON.stringify(rule.contacts || []) %>'></select>
                            </div>
                            <div class="mb-3">
                              <label for="editStatus-<%= rule.id %>" class="form-label">Status</label>
                              <select class="form-select form-select-sm" id="editStatus-<%= rule.id %>" name="status">
                                <option value="">-- No status --</option>
                                <% (statusOptions || []).forEach(function(st) { %>
                                  <option value="<%= st.value %>" <%= rule.status === st.value ? 'selected' : '' %>><%= st.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editViolationType-<%= rule.id %>" class="form-label">Violation Type</label>
                              <select class="form-select form-select-sm" id="editViolationType-<%= rule.id %>" name="violation_type">
                                <option value="">-- None --</option>
                                <% (violationTypeOptions || []).forEach(function(vt) { %>
                                  <option value="<%= vt.value %>" <%= rule.violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editViolationDetail-<%= rule.id %>" class="form-label">Violation Detail</label>
                              <textarea class="form-control form-control-sm" id="editViolationDetail-<%= rule.id %>" name="violation_detail" rows="1"><%= rule.violation_detail || '' %></textarea>
                            </div>
                            <div class="mb-3 position-relative">
                              <label for="editRuleTags-<%= rule.id %>" class="form-label">Tags</label>
                              <select id="editRuleTags-<%= rule.id %>" name="tags[]" class="form-select form-select-sm select2" multiple data-selected='<%- JSON.stringify(rule.tags || []) %>'></select>
                            </div>
                            <div class="mb-3">
                              <label for="editDescription-<%= rule.id %>" class="form-label">Description</label>
                              <textarea class="form-control form-control-sm" id="editDescription-<%= rule.id %>" name="description" rows="2"><%= rule.description || '' %></textarea>
                            </div>
                            <div class="modal-footer d-flex justify-content-end">
                              <button type="submit" class="btn btn-primary btn-sm">Save changes</button>
                              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <tr><td colspan="9" class="text-center">No rules found</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="card-footer clearfix">
          <div class="d-flex justify-content-between align-items-center px-3 pb-2" style="padding-top: 1rem;">
            <div>
              <span>Showing <%= ruleList && ruleList.length ? ((page - 1) * pageSize + 1) : 0 %> - <%= ruleList && ruleList.length ? ((page - 1) * pageSize + ruleList.length) : 0 %> of <%= totalCount %> rules</span>
            </div>
          </div>
          <ul class="pagination pagination-sm m-0 float-end">
            <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page - 1 %>&pageSize=<%= pageSize %>" tabindex="-1">Previous</a>
            </li>
            <% 
              let startPage = 1;
              let endPage = totalPages;
              if (totalPages > 10) {
                if (page <= 5) {
                  startPage = 1;
                  endPage = 10;
                } else if (page + 4 >= totalPages) {
                  startPage = totalPages - 9;
                  endPage = totalPages;
                } else {
                  startPage = page - 5 + 1;
                  endPage = page + 4;
                }
              }
              for (let i = startPage; i <= endPage; i++) { 
            %>
              <li class="page-item <%= i === page ? 'active' : '' %>"><a class="page-link" href="?page=<%= i %>&pageSize=<%= pageSize %>"><%= i %></a></li>
            <% } %>
            <% if (endPage < totalPages) { %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% } %>
            <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page + 1 %>&pageSize=<%= pageSize %>">Next</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <% if (ruleList && ruleList.length > 0) { ruleList.forEach(function(rule) { %>
    <div class="modal fade" id="ruleDetailModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleDetailModalLabel-<%= rule.id %>" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content firewall-detail-modal">
          <div class="modal-header">
            <h5 class="modal-title" id="ruleDetailModalLabel-<%= rule.id %>">Firewall Rule Detail</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <dl class="row mb-0">
              <dt class="col-sm-4">Rule Name</dt>
              <dd class="col-sm-8"><%= rule.rulename %></dd>
              <dt class="col-sm-4">Source Zone</dt>
              <dd class="col-sm-8"><%= rule.src_zone || '' %></dd>
              <dt class="col-sm-4">Source</dt>
              <dd class="col-sm-8"><%= rule.src %></dd>
              <dt class="col-sm-4">Source Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.src_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Destination Zone</dt>
              <dd class="col-sm-8"><%= rule.dst_zone || '' %></dd>
              <dt class="col-sm-4">Destination</dt>
              <dd class="col-sm-8"><%= rule.dst %></dd>
              <dt class="col-sm-4">Destination Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.dst_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Service</dt>
              <dd class="col-sm-8"><%= rule.services || '' %></dd>
              <dt class="col-sm-4">Application</dt>
              <dd class="col-sm-8"><%= rule.application || '' %></dd>
              <dt class="col-sm-4">URL</dt>
              <dd class="col-sm-8"><%= rule.url || '' %></dd>
              <dt class="col-sm-4">Action</dt>
              <dd class="col-sm-8"><%= rule.action %></dd>
              <dt class="col-sm-4">OU (Unit)</dt>
              <dd class="col-sm-8"><%= rule.ou_name || '' %></dd>
              <dt class="col-sm-4">Contacts</dt>
              <dd class="col-sm-8">
                <% if (rule.contacts && rule.contacts.length > 0) { %>
                  <% rule.contacts.forEach(function(c, i) { %>
                    <span><%= c.name %><%= c.email ? ' (' + c.email + ')' : '' %><%= i < rule.contacts.length - 1 ? ', ' : '' %></span>
                  <% }) %>
                <% } else { %>
                  <span class="text-muted">No contacts</span>
                <% } %>
              </dd>
              <dt class="col-sm-4">Violation Type</dt>
              <dd class="col-sm-8"><%= rule.violation_type || '' %></dd>
              <dt class="col-sm-4">Violation Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.violation_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Solution Proposal</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_proposal || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Solution Confirm</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_confirm || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Status</dt>
              <dd class="col-sm-8"><%= rule.status || '' %></dd>
              <dt class="col-sm-4">Description</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.description || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Tags</dt>
              <dd class="col-sm-8">
                <% if (rule.tagNames && rule.tagNames.length > 0) { %>
                  <% rule.tagNames.forEach(function(tag) { %>
                    <span class="badge bg-light text-dark" style="font-size:1rem; font-weight:400; padding:0.35em 0.8em;"><%= tag %></span>
                  <% }) %>
                <% } else { %>
                  <span class="text-muted">No tags</span>
                <% } %>
              </dd>
              <dt class="col-sm-4">Created At</dt>
              <dd class="col-sm-8"><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></dd>
              <dt class="col-sm-4">Updated At</dt>
              <dd class="col-sm-8"><%= rule.updated_at ? (rule.updated_at.toLocaleString ? rule.updated_at.toLocaleString() : rule.updated_at) : '' %></dd>
              <dt class="col-sm-4">Updated By</dt>
              <dd class="col-sm-8"><%= rule.updated_by || '' %></dd>
            </dl>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <% }) } %>
</div>
<style>
#addRuleModal .mb-3.position-relative { position: relative; }
.select2-container--bootstrap-5.select2-container--open {
  z-index: 9999 !important;
}
.firewall-detail-modal dl.row {
  margin-bottom: 0;
}
.firewall-detail-modal dt,
.firewall-detail-modal dd {
  padding-top: 0.35rem;
  padding-bottom: 0.35rem;
  margin-bottom: 0;
}
.firewall-detail-modal dt {
  font-weight: 600;
  color: #495057;
}
.firewall-detail-modal dd {
  color: #222;
}
</style>
<script>
$(function() {
  function getDropdownParent(element) {
    return $(element).closest('.modal-content');
  }

  // --- TỐI ƯU FILTER MODAL: KHỞI TẠO SELECT2 NGAY TỪ ĐẦU, KHÔNG KHỞI TẠO LẠI MỖI LẦN MỞ MODAL ---
  var $filterOu = $('#filterRuleOuId');
  var $filterTags = $('#filterRuleTags');
  var $filterContacts = $('#filterRuleContacts');
  var $filterModalContent = $('#filterRuleModal .modal-content');

  // --- FILTER MODAL SELECT2: KHỞI TẠO 1 LẦN, RESET VALUE ĐÚNG CÁCH, KHÔNG LẶP ---
  // Khởi tạo select2 cho filter ngay từ đầu (chỉ 1 lần)
  $filterOu.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select OU (Unit)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/unit',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) { return { results: data }; },
      cache: true
    }
  });
  $filterTags.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select tag(s)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/tag',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) { return { results: data }; },
      cache: true
    }
  });
  $filterContacts.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select contact(s)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/contact',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) { return { results: data }; },
      cache: true
    }
  });

  // Reset filter value đúng cách khi mở modal
  $('#filterRuleModal').on('shown.bs.modal', function() {
    // Reset OU
    $filterOu.val(null).trigger('change');
    <% if (typeof ou_id !== 'undefined' && ou_id) { %>
      $filterOu.val('<%= ou_id %>').trigger('change');
    <% } %>
    // Reset Tags
    $filterTags.val(null).trigger('change');
    <% if (typeof tags !== 'undefined' && Array.isArray(tags) && tags.length > 0) { %>
      var tagData = <%- JSON.stringify(tags) %>;
      $filterTags.val(tagData).trigger('change');
    <% } %>
    // Reset Contacts
    $filterContacts.val(null).trigger('change');
    <% if (typeof contacts !== 'undefined' && Array.isArray(contacts) && contacts.length > 0) { %>
      var contactData = <%- JSON.stringify(contacts) %>;
      $filterContacts.val(contactData).trigger('change');
    <% } %>
  });

  // Destroy select2 when modal closes to avoid duplicate init
  $('#addRuleModal').on('hidden.bs.modal', function() {
    // Remove aria-hidden if still present (fixes focus warning)
    $(this).removeAttr('aria-hidden');
    if ($('#ruleOuId').hasClass('select2-hidden-accessible')) $('#ruleOuId').select2('destroy');
    if ($('#ruleTags').hasClass('select2-hidden-accessible')) $('#ruleTags').select2('destroy');
    if ($('#ruleContacts').hasClass('select2-hidden-accessible')) $('#ruleContacts').select2('destroy');
  });

  // Init select2 when modal opens, so dropdownParent is always correct
  $('#addRuleModal').on('shown.bs.modal', function() {
    var $modalContent = $('#addRuleModal .modal-content');
    if ($('#ruleOuId').hasClass('select2-hidden-accessible')) $('#ruleOuId').select2('destroy');
    if ($('#ruleTags').hasClass('select2-hidden-accessible')) $('#ruleTags').select2('destroy');
    if ($('#ruleContacts').hasClass('select2-hidden-accessible')) $('#ruleContacts').select2('destroy');
    $('#ruleOuId').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select OU (Unit)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/unit',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $('#ruleTags').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $('#ruleContacts').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
  });
  <% ruleList.forEach(function(rule) { %>
    $('#ruleEditModal-<%= rule.id %>').on('shown.bs.modal', function() {
      var $modalContent = $('#ruleEditModal-<%= rule.id %> .modal-content');
      var $ou = $('#editRuleOuId-<%= rule.id %>');
      var $tags = $('#editRuleTags-<%= rule.id %>');
      var $contacts = $('#editRuleContacts-<%= rule.id %>');
      if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
      if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
      if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
      $ou.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select OU (Unit)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/unit',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      $tags.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select tag(s)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/tag',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      $contacts.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select contact(s)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/contact',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      // Pre-select OU if present
      if (<%= rule.ou_id ? 'true' : 'false' %>) {
        var ouOption = new Option('<%= rule.ou_name || '' %>', '<%= rule.ou_id %>', true, true);
        $ou.append(ouOption).trigger('change');
      }
      // Pre-select tags if present
      var tagData = <%- JSON.stringify((rule.tags || []).map(function(t) { return t.id !== undefined ? t.id : t; })) %>;
      var tagNames = <%- JSON.stringify((rule.tags || []).map(function(t) { return t.name || t; })) %>;
      if (tagData.length > 0) {
        tagData.forEach(function(tid, i) {
          var tagOption = new Option(tagNames[i] || tid, tid, true, true);
          $tags.append(tagOption).trigger('change');
        });
      }
      // Pre-select contacts if present
      var contactData = <%- JSON.stringify(rule.contacts || []) %>;
      if (contactData.length > 0) {
        contactData.forEach(function(c) {
          var label = c.name + (c.email ? ' (' + c.email + ')' : '');
          var contactOption = new Option(label, c.id, true, true);
          $contacts.append(contactOption).trigger('change');
        });
      }
    });
    // Destroy select2 on modal close
    $('#ruleEditModal-<%= rule.id %>').on('hidden.bs.modal', function() {
      var $ou = $('#editRuleOuId-<%= rule.id %>');
      var $tags = $('#editRuleTags-<%= rule.id %>');
      var $contacts = $('#editRuleContacts-<%= rule.id %>');
      if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
      if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
      if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
    });
  <% }) %>
  // Init select2 for filter modal
  $('#filterRuleModal').on('shown.bs.modal', function() {
    var $modalContent = $('#filterRuleModal .modal-content');
    var $ou = $('#filterRuleOuId');
    var $tags = $('#filterRuleTags');
    var $contacts = $('#filterRuleContacts');
    if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
    if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
    if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
    $ou.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select OU (Unit)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/unit',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $tags.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $contacts.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    // --- Persist filter values ---
    <% if (typeof ou_id !== 'undefined' && ou_id) { %>
      var ouOption = new Option('<%= typeof ou_name !== 'undefined' ? ou_name : '' %>', '<%= ou_id %>', true, true);
      $ou.append(ouOption).trigger('change');
    <% } %>
    <% if (typeof tags !== 'undefined' && Array.isArray(tags) && tags.length > 0) { %>
      var tagData = <%- JSON.stringify(tags) %>;
      var tagNames = <%- JSON.stringify(typeof tagNames !== 'undefined' ? tagNames : []) %>;
      tagData.forEach(function(tid, i) {
        var tagOption = new Option(tagNames[i] || tid, tid, true, true);
        $tags.append(tagOption).trigger('change');
      });
    <% } %>
    <% if (typeof contacts !== 'undefined' && Array.isArray(contacts) && contacts.length > 0) { %>
      var contactData = <%- JSON.stringify(contacts) %>;
      var contactNames = <%- JSON.stringify(typeof contactNames !== 'undefined' ? contactNames : []) %>;
      contactData.forEach(function(cid, i) {
        var contactOption = new Option(contactNames[i] || cid, cid, true, true);
        $contacts.append(contactOption).trigger('change');
      });
    <% } %>
  });
  // Nút clear all filter
  $('#clearAllFilterBtn').on('click', function() {
    window.location.href = '/firewall/rule';
  });
});
</script>
