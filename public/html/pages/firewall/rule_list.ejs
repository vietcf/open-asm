<div class="container-fluid">
  <div id="wo-alert-container"></div>
  <form class="input-group mb-3 justify-content-end align-items-center" role="search" method="get" action="/firewall/rule" style="margin-top: 2.5rem; margin-right: 0.5rem; max-width: 500px; margin-left: auto;">
    <input class="form-control rounded-start me-2" type="search" name="search" placeholder="Search any field (name, src, dst, service, action, status, ...)" aria-label="Search" value="<%= typeof search !== 'undefined' ? search : '' %>">
    <select class="form-select form-select-sm me-2" name="pageSize" onchange="this.form.submit()" style="width:90px;max-width:90px;">
      <% (pageSizeOptions || [5,10,15,20]).forEach(function(size) { %>
        <option value="<%= size %>" <%= pageSize == size ? 'selected' : '' %>><%= size %> / page</option>
      <% }) %>
    </select>
    <button class="btn btn-outline-secondary rounded-end" type="submit"><i class="bi bi-search"></i></button>
  </form>
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-end align-items-center">
      <% if (hasPermission('rule.create')) { %>
      <button id="add-rule-btn" type="button" class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addRuleModal">
        <i class="bi bi-plus"></i> Add Rule
      </button>
      <% } %>
      <button type="button" class="btn btn-success btn-sm me-2" id="editMultiWOButton">
        <i class="bi bi-pencil-square"></i> Edit Batch WO
      </button>
      <div id="editWoWarning" class="alert alert-warning d-none" style="position:fixed; top:80px; right:30px; z-index:9999; min-width:200px; max-width:400px; text-align:center;">
        Please select at least one rule to edit WO.
      </div>
      <!-- Add Rule Modal -->
      <div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addRuleModalLabel">Add Firewall Rule</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addRuleForm" action="/firewall/rule" method="POST">
                <div class="mb-3">
                  <label for="firewall_name" class="form-label">Firewall Name <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" id="firewall_name" name="firewall_name" required>
                    <option value="">-- Select Firewall Name --</option>
                    <% (firewallNameOptions || []).forEach(function(fw) { %>
                      <option value="<%= fw.value %>"><%= fw.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="rulename" class="form-label">Rule Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="rulename" name="rulename" required placeholder="Rule Name">
                </div>
                <div class="mb-3">
                  <label for="src_zone" class="form-label">Source Zone</label>
                  <input type="text" class="form-control form-control-sm" id="src_zone" name="src_zone" placeholder="Source Zone">
                </div>
                <div class="mb-3">
                  <label for="src" class="form-label">Source <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="src" name="src" required placeholder="Source">
                </div>
                <div class="mb-3">
                  <label for="src_detail" class="form-label">Source Detail</label>
                  <textarea class="form-control form-control-sm" id="src_detail" name="src_detail" rows="1" placeholder="Source Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="dst_zone" class="form-label">Destination Zone</label>
                  <input type="text" class="form-control form-control-sm" id="dst_zone" name="dst_zone" placeholder="Destination Zone">
                </div>
                <div class="mb-3">
                  <label for="dst" class="form-label">Destination <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" id="dst" name="dst" required placeholder="Destination">
                </div>
                <div class="mb-3">
                  <label for="dst_detail" class="form-label">Destination Detail</label>
                  <textarea class="form-control form-control-sm" id="dst_detail" name="dst_detail" rows="1" placeholder="Destination Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="services" class="form-label">Service</label>
                  <input type="text" class="form-control form-control-sm" id="services" name="services" placeholder="Service/Port">
                </div>
                <div class="mb-3">
                  <label for="application" class="form-label">Application</label>
                  <input type="text" class="form-control form-control-sm" id="application" name="application" placeholder="Application">
                </div>
                <div class="mb-3">
                  <label for="url" class="form-label">URL</label>
                  <input type="text" class="form-control form-control-sm" id="url" name="url" placeholder="URL">
                </div>
                <div class="mb-3">
                  <label for="action" class="form-label">Action <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" id="action" name="action" required>
                    <option value="">-- Select Action --</option>
                    <% (actionsOptions || []).forEach(function(act) { %>
                      <option value="<%= act.value %>"><%= act.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="violation_type" class="form-label">Violation Type</label>
                  <select class="form-select form-select-sm" id="violation_type" name="violation_type">
                    <option value="">-- None --</option>
                    <% (violationTypeOptions || []).forEach(function(vt) { %>
                      <option value="<%= vt.value %>" <%= typeof violation_type !== 'undefined' && violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="violation_detail" class="form-label">Violation Detail</label>
                  <textarea class="form-control form-control-sm" id="violation_detail" name="violation_detail" rows="1" placeholder="Violation Detail"></textarea>
                </div>
                <div class="mb-3">
                  <label for="solution_proposal" class="form-label">Solution Proposal</label>
                  <textarea class="form-control form-control-sm" id="solution_proposal" name="solution_proposal" rows="1" placeholder="Solution Proposal"></textarea>
                </div>
                <div class="mb-3">
                  <label for="solution_confirm" class="form-label">Solution Confirm</label>
                  <textarea class="form-control form-control-sm" id="solution_confirm" name="solution_confirm" rows="1" placeholder="Solution Confirm"></textarea>
                </div>
                <div class="mb-3 position-relative">
                  <label for="ruleOuId" class="form-label">OU (Unit)</label>
                  <select id="ruleOuId" name="ou_id" class="form-control" style="width:100%" data-placeholder="Select OU (Unit)"></select>
                </div>
                <div class="mb-3">
                  <label for="ruleContacts" class="form-label">Contacts</label>
                  <select id="ruleContacts" name="contacts[]" class="form-control" multiple data-placeholder="Select contact(s)"></select>
                </div>
                <div class="mb-3 position-relative">
                  <label for="ruleTags" class="form-label">Tags</label>
                  <select id="ruleTags" name="tags[]" class="form-control" multiple></select>
                </div>
                <div class="mb-3">
                  <label for="audit_batch" class="form-label">Audit Batch</label>
                  <input type="text" class="form-control form-control-sm" id="audit_batch" name="audit_batch" placeholder="e.g. 2023-01,2023-02">
                  <div class="invalid-feedback" id="auditBatchFeedback">
                    Each audit batch must be in the format yyyy-01 or yyyy-02 (e.g. 2023-01,2024-02).
                  </div>
                </div>
                <div class="mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control form-control-sm" id="description" name="description" rows="2" placeholder="Description"></textarea>
                </div>
                <div class="mb-3">
                  <label for="status" class="form-label">Status</label>
                  <select class="form-select form-select-sm" id="status" name="status">
                    <option value="">-- No status --</option>
                    <% (statusOptions || []).forEach(function(st) { %>
                      <option value="<%= st.value %>"><%= st.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="work_order" class="form-label">Work Order</label>
                  <input type="text" class="form-control form-control-sm" id="work_order" name="work_order" placeholder="Work Order">
                </div>
                <div class="modal-footer d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-sm">Add Rule</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <form action="/firewall/rule/export" method="GET" style="display:inline;" class="me-2" id="exportRuleForm">
        <input type="hidden" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>">
        <input type="hidden" name="ou_id" value="<%= typeof filterUnitId !== 'undefined' ? filterUnitId : '' %>">
        <% if (typeof filterTagIds !== 'undefined' && Array.isArray(filterTagIds)) { filterTagIds.forEach(function(t) { %>
          <input type="hidden" name="tags[]" value="<%= t %>">
        <% }) } %>
        <% if (typeof filterContactIds !== 'undefined' && Array.isArray(filterContactIds)) { filterContactIds.forEach(function(c) { %>
          <input type="hidden" name="contacts[]" value="<%= c %>">
        <% }) } %>
        <input type="hidden" name="violation_type" value="<%= typeof violation_type !== 'undefined' ? violation_type : '' %>">
        <input type="hidden" name="status" value="<%= typeof status !== 'undefined' ? status : '' %>">
        <input type="hidden" name="firewall_name" value="<%= typeof firewall_name !== 'undefined' ? firewall_name : '' %>">
        <button type="submit" class="btn btn-warning btn-sm">
          <i class="bi bi-download"></i> Export
        </button>
      </form>
      <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#filterRuleModal">
        <i class="bi bi-funnel"></i> Filter
      </button>
    </div>
  </div>
  <!-- Filter Rule Modal -->
  <div class="modal fade" id="filterRuleModal" tabindex="-1" aria-labelledby="filterRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterRuleModalLabel">Filter Firewall Rules</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="get" action="/firewall/rule">
          <!-- Preserve current pageSize and search -->
          <input type="hidden" name="pageSize" value="<%= typeof pageSize !== 'undefined' ? pageSize : 10 %>">
          <input type="hidden" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>">
          <div class="modal-body">
            <div class="mb-3">
              <label for="filterRuleFirewallName" class="form-label">Firewall Name</label>
              <select class="form-select form-select-sm" id="filterRuleFirewallName" name="firewall_name">
                <option value="">-- All --</option>
                <% (firewallNameOptions || []).forEach(function(fw) { %>
                  <option value="<%= fw.value %>" <%= typeof firewall_name !== 'undefined' && firewall_name === fw.value ? 'selected' : '' %>><%= fw.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="mb-3">
              <label for="filterRuleOuId" class="form-label">OU (Unit)</label>
              <select id="filterRuleOuId" name="ou_id" class="form-control" style="width:100%"></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleContacts" class="form-label">Contacts</label>
              <select id="filterRuleContacts" name="contacts[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleTags" class="form-label">Tags</label>
              <select id="filterRuleTags" name="tags[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label for="filterRuleAuditBatch" class="form-label">Audit Batch</label>
              <input type="text" class="form-control form-control-sm" id="filterRuleAuditBatch" name="audit_batch" placeholder="e.g. 2023-01,2023-02" value="<%= typeof audit_batch !== 'undefined' ? audit_batch : '' %>">
            </div>
            <div class="mb-3">
              <label for="filterRuleViolationType" class="form-label">Violation Type</label>
              <select class="form-select form-select-sm" id="filterRuleViolationType" name="violation_type">
                <option value="">-- All --</option>
                <% (violationTypeOptions || []).forEach(function(vt) { %>
                  <option value="<%= vt.value %>" <%= typeof violation_type !== 'undefined' && violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="mb-3">
              <label for="filterRuleStatus" class="form-label">Status</label>
              <select class="form-select form-select-sm" id="filterRuleStatus" name="status">
                <option value="">-- All --</option>
                <% (statusOptions || []).forEach(function(st) { %>
                  <option value="<%= st.value %>" <%= typeof status !== 'undefined' && status === st.value ? 'selected' : '' %>><%= st.label %></option>
                <% }) %>
              </select>
            </div>
            <!-- Add more filter fields as needed -->
          </div>
          <div class="modal-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm">Apply Filter</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning btn-sm ms-2" id="clearAllFilterBtn">Clear All Filter</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title mb-0">Firewall Rules List</h3>
        </div>
        <div class="card-body table-responsive p-0">
          <% if (typeof error !== 'undefined' && error) { %>
            <div id="toast-error" class="toast-error alert alert-danger" style="position:absolute; left:0; right:0; top:0; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">
              <%= error %>
            </div>
            <script>setTimeout(function(){var el=document.getElementById('toast-error');if(el)el.style.display='none';},6000);</script>
          <% } %>
          <% if (typeof success !== 'undefined' && success) { %>
            <div id="toast-success" class="toast-success alert alert-success" style="position:absolute; left:0; right:0; top:40px; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">
              <%= success %>
            </div>
            <script>setTimeout(function(){var el=document.getElementById('toast-success');if(el)el.style.display='none';},6000);</script>
          <% } %>
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="selectAllRules"></th>
                <th>No.</th>
                <th>Firewall Name</th>
                <th>Rule Name</th>
                <th>Source</th>
                <th>Destination</th>
                <th>Service</th>
                <!-- <th>Protocol</th> -->
                <th>Status</th>
                <th>Work Order</th>
                <!-- <th>Created At</th> -->
                <th>OU (Unit)</th>
                <th>Violation Type</th>
                <th>Tags</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (ruleList && ruleList.length > 0) { %>
                <% ruleList.forEach(function(rule, idx) { %>
                  <tr>
                    <td><input type="checkbox" class="rule-checkbox" value="<%= rule.id %>"></td>
                    <td><%= (page - 1) * pageSize + idx + 1 %></td>
                    <td><%= rule.firewall_name || '' %></td>
                    <td><%= rule.rulename %></td>
                    <td><%= rule.src %></td>
                    <td><%= rule.dst %></td>
                    <td><%= rule.services %></td>
                    <!-- <td><%= rule.protocol || '' %></td> -->
                    <td><%= rule.status || '' %></td>
                    <td><%= rule.work_order || '' %></td>
                    <!-- <td><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></td> -->
                    <td><%= rule.ou_name || '' %></td>
                    <td><%= rule.violation_type || '' %></td>
                    <td>
                      <% if (rule.tagNames && rule.tagNames.length > 0) { %>
                        <% rule.tagNames.forEach(function(tag) { %>
                          <span class="badge bg-primary text-white" style="font-size:1rem; font-weight:500; padding:0.15em 0.5em;"><%= tag %></span>
                        <% }) %>
                      <% } else { %>
                        <span class="text-muted">No tags</span>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <a href="#" class="btn btn-info btn-sm" title="Show" data-bs-toggle="modal" data-bs-target="#ruleDetailModal-<%= rule.id %>"><i class="bi bi-eye"></i></a>
                      <% if (hasPermission('rule.update')) { %>
                      <button type="button" class="btn btn-warning btn-sm" title="Edit" data-bs-toggle="modal" data-bs-target="#ruleEditModal-<%= rule.id %>"><i class="bi bi-pencil"></i></button>
                      <% } %>
                      <% if (hasPermission('rule.delete')) { %>
                      <form action="/firewall/rule/<%= rule.id %>?_method=DELETE" method="POST" style="display:inline">
                        <button type="submit" class="btn btn-danger btn-sm" title="Delete" onclick="return confirm('Are you sure you want to delete this rule?')"><i class="bi bi-trash"></i></button>
                      </form>
                      <% } %>
                    </td>
                  </tr>
                  <!-- Rule Detail Modal -->
                  <div class="modal fade" id="ruleDetailModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleDetailModalLabel-<%= rule.id %>" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content firewall-detail-modal">
                        <div class="modal-header">
                          <h5 class="modal-title" id="ruleDetailModalLabel-<%= rule.id %>">Firewall Rule Detail</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <dl class="row mb-0">
                            <dt class="col-sm-4">ID</dt>
                            <dd class="col-sm-8"><%= rule.id %></dd>
                            <dt class="col-sm-4">Firewall Name</dt>
                            <dd class="col-sm-8"><%= rule.firewall_name || '' %></dd>
                            <dt class="col-sm-4">Rule Name</dt>
                            <dd class="col-sm-8"><%= rule.rulename %></dd>
                            <dt class="col-sm-4">Source Zone</dt>
                            <dd class="col-sm-8"><%= rule.src_zone || '' %></dd>
                            <dt class="col-sm-4">Source</dt>
                            <dd class="col-sm-8"><%= rule.src %></dd>
                            <dt class="col-sm-4">Source Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.src_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Destination Zone</dt>
                            <dd class="col-sm-8"><%= rule.dst_zone || '' %></dd>
                            <dt class="col-sm-4">Destination</dt>
                            <dd class="col-sm-8"><%= rule.dst %></dd>
                            <dt class="col-sm-4">Destination Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.dst_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Service</dt>
                            <dd class="col-sm-8"><%= rule.services || '' %></dd>
                            <dt class="col-sm-4">Application</dt>
                            <dd class="col-sm-8"><%= rule.application || '' %></dd>
                            <dt class="col-sm-4">URL</dt>
                            <dd class="col-sm-8"><%= rule.url || '' %></dd>
                            <dt class="col-sm-4">Action</dt>
                            <dd class="col-sm-8"><%= rule.action %></dd>
                            <dt class="col-sm-4">Violation Type</dt>
                            <dd class="col-sm-8"><%= rule.violation_type || '' %></dd>
                            <dt class="col-sm-4">Violation Detail</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.violation_detail || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Solution Proposal</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_proposal || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Solution Confirm</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_confirm || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Tags</dt>
                            <dd class="col-sm-8">
                              <% if (rule.tagNames && rule.tagNames.length > 0) { %>
                                <% rule.tagNames.forEach(function(tag) { %>
                                  <span class="badge bg-primary text-white" style="font-size:1rem; font-weight:500; padding:0.15em 0.5em;"><%= tag %></span>
                                <% }) %>
                              <% } else { %>
                                <span class="text-muted">No tags</span>
                              <% } %>
                            </dd>
                            <dt class="col-sm-4">Audit Batch</dt>
                            <dd class="col-sm-8"><%= rule.audit_batch || '' %></dd>
                            <dt class="col-sm-4">Description</dt>
                            <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.description || '').replace(/\r?\n/g, '<br>') %></dd>
                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8"><%= rule.status || '' %></dd>
                            <dt class="col-sm-4">Work Order</dt>
                            <dd class="col-sm-8"><%= rule.work_order || '' %></dd>
                            <dt class="col-sm-4">OU (Unit)</dt>
                            <dd class="col-sm-8"><%= rule.ou_name || '' %></dd>
                            <dt class="col-sm-4">Contacts</dt>
                            <dd class="col-sm-8">
                              <% if (rule.contacts && rule.contacts.length > 0) { %>
                                <% rule.contacts.forEach(function(c, i) { %>
                                  <span><%= c.name %><%= c.email ? ' (' + c.email + ')' : '' %><%= i < rule.contacts.length - 1 ? ', ' : '' %></span>
                                <% }) %>
                              <% } else { %>
                                <span class="text-muted">No contacts</span>
                              <% } %>
                            </dd>
                            <dt class="col-sm-4">Created At</dt>
                            <dd class="col-sm-8"><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></dd>
                            <dt class="col-sm-4">Updated At</dt>
                            <dd class="col-sm-8"><%= rule.updated_at ? (rule.updated_at.toLocaleString ? rule.updated_at.toLocaleString() : rule.updated_at) : '' %></dd>
                            <dt class="col-sm-4">Updated By</dt>
                            <dd class="col-sm-8"><%= rule.updated_by || '' %></dd>
                          </dl>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Rule Edit Modal -->
                  <div class="modal fade" id="ruleEditModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleEditModalLabel-<%= rule.id %>" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="ruleEditModalLabel-<%= rule.id %>">Edit Firewall Rule</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form action="/firewall/rule/<%= rule.id %>" method="POST">
                            <div class="mb-3">
                              <label for="editFirewallName-<%= rule.id %>" class="form-label">Firewall Name <span class="text-danger">*</span></label>
                              <select class="form-select form-select-sm" id="editFirewallName-<%= rule.id %>" name="firewall_name" required>
                                <option value="">-- Select Firewall Name --</option>
                                <% (firewallNameOptions || []).forEach(function(fw) { %>
                                  <option value="<%= fw.value %>" <%= rule.firewall_name === fw.value ? 'selected' : '' %>><%= fw.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editRulename-<%= rule.id %>" class="form-label">Rule Name <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editRulename-<%= rule.id %>" name="rulename" value="<%= rule.rulename %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editSrcZone-<%= rule.id %>" class="form-label">Source Zone</label>
                              <input type="text" class="form-control form-control-sm" id="editSrcZone-<%= rule.id %>" name="src_zone" value="<%= rule.src_zone || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editSrc-<%= rule.id %>" class="form-label">Source <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editSrc-<%= rule.id %>" name="src" value="<%= rule.src %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editSrcDetail-<%= rule.id %>" class="form-label">Source Detail</label>
                              <textarea class="form-control form-control-sm" id="editSrcDetail-<%= rule.id %>" name="src_detail" rows="1"><%= rule.src_detail || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editDstZone-<%= rule.id %>" class="form-label">Destination Zone</label>
                              <input type="text" class="form-control form-control-sm" id="editDstZone-<%= rule.id %>" name="dst_zone" value="<%= rule.dst_zone || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editDst-<%= rule.id %>" class="form-label">Destination <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-sm" id="editDst-<%= rule.id %>" name="dst" value="<%= rule.dst %>" required>
                            </div>
                            <div class="mb-3">
                              <label for="editDstDetail-<%= rule.id %>" class="form-label">Destination Detail</label>
                              <textarea class="form-control form-control-sm" id="editDstDetail-<%= rule.id %>" name="dst_detail" rows="1"><%= rule.dst_detail || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editServices-<%= rule.id %>" class="form-label">Service</label>
                              <input type="text" class="form-control form-control-sm" id="editServices-<%= rule.id %>" name="services" value="<%= rule.services || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editApplication-<%= rule.id %>" class="form-label">Application</label>
                              <input type="text" class="form-control form-control-sm" id="editApplication-<%= rule.id %>" name="application" value="<%= rule.application || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editUrl-<%= rule.id %>" class="form-label">URL</label>
                              <input type="text" class="form-control form-control-sm" id="editUrl-<%= rule.id %>" name="url" value="<%= rule.url || '' %>">
                            </div>
                            <div class="mb-3">
                              <label for="editAction-<%= rule.id %>" class="form-label">Action <span class="text-danger">*</span></label>
                              <select class="form-select form-select-sm" id="editAction-<%= rule.id %>" name="action" required>
                                <option value="">-- Select Action --</option>
                                <% (actionsOptions || []).forEach(function(act) { %>
                                  <option value="<%= act.value %>" <%= rule.action === act.value ? 'selected' : '' %>><%= act.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3 position-relative">
                              <label for="editRuleOuId-<%= rule.id %>" class="form-label">OU (Unit)</label>
                              <select id="editRuleOuId-<%= rule.id %>" name="ou_id" class="form-control" style="width:100%" data-placeholder="Select OU (Unit)"></select>
                            </div>
                            <div class="mb-3">
                              <label for="editRuleContacts-<%= rule.id %>" class="form-label">Contacts</label>
                              <select id="editRuleContacts-<%= rule.id %>" name="contacts[]" class="form-control" multiple data-selected='<%- JSON.stringify(rule.contacts || []) %>' data-placeholder="Select contact(s)"></select>
                            </div>
                            <div class="mb-3">
                              <label for="editViolationType-<%= rule.id %>" class="form-label">Violation Type</label>
                              <select class="form-select form-select-sm" id="editViolationType-<%= rule.id %>" name="violation_type">
                                <option value="">-- None --</option>
                                <% (violationTypeOptions || []).forEach(function(vt) { %>
                                  <option value="<%= vt.value %>" <%= rule.violation_type === vt.value ? 'selected' : '' %>><%= vt.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editViolationDetail-<%= rule.id %>" class="form-label">Violation Detail</label>
                              <textarea class="form-control form-control-sm" id="editViolationDetail-<%= rule.id %>" name="violation_detail" rows="1"><%= rule.violation_detail || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editSolutionProposal-<%= rule.id %>" class="form-label">Solution Proposal</label>
                              <textarea class="form-control form-control-sm" id="editSolutionProposal-<%= rule.id %>" name="solution_proposal" rows="1"><%= rule.solution_proposal || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editSolutionConfirm-<%= rule.id %>" class="form-label">Solution Confirm</label>
                              <textarea class="form-control form-control-sm" id="editSolutionConfirm-<%= rule.id %>" name="solution_confirm" rows="1"><%= rule.solution_confirm || '' %></textarea>
                            </div>
                            <div class="mb-3 position-relative">
                              <label for="editRuleTags-<%= rule.id %>" class="form-label">Tags</label>
                              <select id="editRuleTags-<%= rule.id %>" name="tags[]" class="form-control" multiple data-selected='<%- JSON.stringify(rule.tags || []) %>'></select>
                            </div>
                            <div class="mb-3">
                              <label for="editAuditBatch-<%= rule.id %>" class="form-label">Audit Batch</label>
                              <input type="text" class="form-control form-control-sm edit-audit-batch" id="editAuditBatch-<%= rule.id %>" name="audit_batch" value="<%= rule.audit_batch || '' %>" placeholder="e.g. 2023-01,2023-02">
                              <div class="invalid-feedback">
                                Each audit batch must be in the format yyyy-01 or yyyy-02 (e.g. 2023-01,2024-02).
                              </div>
                            </div>
                            <div class="mb-3">
                              <label for="editDescription-<%= rule.id %>" class="form-label">Description</label>
                              <textarea class="form-control form-control-sm" id="editDescription-<%= rule.id %>" name="description" rows="2"><%= rule.description || '' %></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="editStatus-<%= rule.id %>" class="form-label">Status</label>
                              <select class="form-select form-select-sm" id="editStatus-<%= rule.id %>" name="status">
                                <option value="">-- No status --</option>
                                <% (statusOptions || []).forEach(function(st) { %>
                                  <option value="<%= st.value %>" <%= rule.status === st.value ? 'selected' : '' %>><%= st.label %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="editWorkOrder-<%= rule.id %>" class="form-label">Work Order</label>
                              <input type="text" class="form-control form-control-sm" id="editWorkOrder-<%= rule.id %>" name="work_order" value="<%= rule.work_order || '' %>">
                            </div>
                            <div class="modal-footer d-flex justify-content-end">
                              <button type="submit" class="btn btn-primary btn-sm">Save changes</button>
                              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">Close</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <tr><td colspan="9" class="text-center">No rules found</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="card-footer clearfix">
          <div class="d-flex justify-content-between align-items-center px-3 pb-2" style="padding-top: 1rem;">
            <div>
              <span>Showing <%= ruleList && ruleList.length ? ((page - 1) * pageSize + 1) : 0 %> - <%= ruleList && ruleList.length ? ((page - 1) * pageSize + ruleList.length) : 0 %> of <%= totalCount %> rules</span>
            </div>
          </div>
          <ul class="pagination pagination-sm m-0 float-end">
            <% 
              let startPage = 1;
              let endPage = totalPages;
              if (totalPages > 10) {
                if (page <= 5) {
                  startPage = 1;
                  endPage = 10;
                } else if (page + 4 >= totalPages) {
                  startPage = totalPages - 9;
                  endPage = totalPages;
                } else {
                  startPage = page - 5 + 1;
                  endPage = page + 4;
                }
              }
              // Build filter query string for pagination links
              function buildRuleFilterQuery() {
                let params = [];
                if (typeof search !== 'undefined' && search) params.push('search=' + encodeURIComponent(search));
                if (typeof pageSize !== 'undefined' && pageSize) params.push('pageSize=' + encodeURIComponent(pageSize));
                if (typeof firewall_name !== 'undefined' && firewall_name) params.push('firewall_name=' + encodeURIComponent(firewall_name));
                if (typeof filterUnitId !== 'undefined' && filterUnitId) params.push('ou_id=' + encodeURIComponent(filterUnitId));
                if (typeof filterTagIds !== 'undefined' && Array.isArray(filterTagIds) && filterTagIds.length) filterTagIds.forEach(function(id) { params.push('tags[]=' + encodeURIComponent(id)); });
                if (typeof filterContactIds !== 'undefined' && Array.isArray(filterContactIds) && filterContactIds.length) filterContactIds.forEach(function(id) { params.push('contacts[]=' + encodeURIComponent(id)); });
                if (typeof audit_batch !== 'undefined' && audit_batch) params.push('audit_batch=' + encodeURIComponent(audit_batch));
                if (typeof violation_type !== 'undefined' && violation_type) params.push('violation_type=' + encodeURIComponent(violation_type));
                if (typeof status !== 'undefined' && status) params.push('status=' + encodeURIComponent(status));
                return params.join('&');
              }
              const ruleFilterQuery = buildRuleFilterQuery();
            %>
            <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page - 1 %><%= ruleFilterQuery ? '&' + ruleFilterQuery : '' %>" tabindex="-1">Previous</a>
            </li>
            <% for (let i = startPage; i <= endPage; i++) { %>
              <li class="page-item <%= i === page ? 'active' : '' %>"><a class="page-link" href="?page=<%= i %><%= ruleFilterQuery ? '&' + ruleFilterQuery : '' %>"><%= i %></a></li>
            <% } %>
            <% if (endPage < totalPages) { %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% } %>
            <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page + 1 %><%= ruleFilterQuery ? '&' + ruleFilterQuery : '' %>">Next</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <% if (ruleList && ruleList.length > 0) { ruleList.forEach(function(rule) { %>
    <div class="modal fade" id="ruleDetailModal-<%= rule.id %>" tabindex="-1" aria-labelledby="ruleDetailModalLabel-<%= rule.id %>" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content firewall-detail-modal">
          <div class="modal-header">
            <h5 class="modal-title" id="ruleDetailModalLabel-<%= rule.id %>">Firewall Rule Detail</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <dl class="row mb-0">
              <dt class="col-sm-4">Rule Name</dt>
              <dd class="col-sm-8"><%= rule.rulename %></dd>
              <dt class="col-sm-4">Source Zone</dt>
              <dd class="col-sm-8"><%= rule.src_zone || '' %></dd>
              <dt class="col-sm-4">Source</dt>
              <dd class="col-sm-8"><%= rule.src %></dd>
              <dt class="col-sm-4">Source Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.src_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Destination Zone</dt>
              <dd class="col-sm-8"><%= rule.dst_zone || '' %></dd>
              <dt class="col-sm-4">Destination</dt>
              <dd class="col-sm-8"><%= rule.dst %></dd>
              <dt class="col-sm-4">Destination Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.dst_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Service</dt>
              <dd class="col-sm-8"><%= rule.services || '' %></dd>
              <dt class="col-sm-4">Application</dt>
              <dd class="col-sm-8"><%= rule.application || '' %></dd>
              <dt class="col-sm-4">URL</dt>
              <dd class="col-sm-8"><%= rule.url || '' %></dd>
              <dt class="col-sm-4">Action</dt>
              <dd class="col-sm-8"><%= rule.action %></dd>
              <dt class="col-sm-4">OU (Unit)</dt>
              <dd class="col-sm-8"><%= rule.ou_name || '' %></dd>
              <dt class="col-sm-4">Contacts</dt>
              <dd class="col-sm-8">
                <% if (rule.contacts && rule.contacts.length > 0) { %>
                  <% rule.contacts.forEach(function(c, i) { %>
                    <span><%= c.name %><%= c.email ? ' (' + c.email + ')' : '' %><%= i < rule.contacts.length - 1 ? ', ' : '' %></span>
                  <% }) %>
                <% } else { %>
                  <span class="text-muted">No contacts</span>
                <% } %>
              </dd>
              <dt class="col-sm-4">Violation Type</dt>
              <dd class="col-sm-8"><%= rule.violation_type || '' %></dd>
              <dt class="col-sm-4">Violation Detail</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.violation_detail || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Solution Proposal</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_proposal || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Solution Confirm</dt>
              <dd class="col-sm-8" style="white-space:pre-line"><%- (rule.solution_confirm || '').replace(/\r?\n/g, '<br>') %></dd>
              <dt class="col-sm-4">Created At</dt>
              <dd class="col-sm-8"><%= rule.created_at ? (rule.created_at.toLocaleString ? rule.created_at.toLocaleString() : rule.created_at) : '' %></dd>
              <dt class="col-sm-4">Updated At</dt>
              <dd class="col-sm-8"><%= rule.updated_at ? (rule.updated_at.toLocaleString ? rule.updated_at.toLocaleString() : rule.updated_at) : '' %></dd>
              <dt class="col-sm-4">Updated By</dt>
              <dd class="col-sm-8"><%= rule.updated_by || '' %></dd>
            </dl>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <% }) } %>
  <!-- Edit WO Modal -->
  <div class="modal fade" id="editWoModal" tabindex="-1" aria-labelledby="editWoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editWoModalLabel">Edit Work Order (WO)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editWoForm">
            <div class="mb-3">
              <label for="woInput" class="form-label">Work Order</label>
              <input type="text" class="form-control form-control-sm" id="woInput" name="work_order" placeholder="Enter WO">
            </div>
            <div class="modal-footer d-flex justify-content-end">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary btn-sm ms-2" id="saveWoBtn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
#addRuleModal .mb-3.position-relative { position: relative; }
.select2-container--bootstrap-5.select2-container--open {
  z-index: 9999 !important;
}
.firewall-detail-modal dl.row {
  margin-bottom: 0;
}
.firewall-detail-modal dt,
.firewall-detail-modal dd {
  padding-top: 0.35rem;
  padding-bottom: 0.35rem;
  margin-bottom: 0;
}
.firewall-detail-modal dt {
  font-weight: 600;
  color: #495057;
}
.firewall-detail-modal dd {
  color: #222;
}
</style>
<script>
// --- GLOBAL DEBUG: Confirm script loaded and catch JS errors ---
window.onerror = function(msg, url, line, col, error) {
  console.error('[Global JS Error]', msg, url, line, col, error);
};
$(function() {
  function getDropdownParent(element) {
    return $(element).closest('.modal-content');
  }

  // --- TỐI ƯU FILTER MODAL: KHỞI TẠO SELECT2 NGAY TỪ ĐẦU, KHÔNG KHỞI TẠO LẠI MỖI LẦN ---
  var $filterOu = $('#filterRuleOuId');
  var $filterTags = $('#filterRuleTags');
  var $filterContacts = $('#filterRuleContacts');
  var $filterModalContent = $('#filterRuleModal .modal-content');

  // --- FILTER MODAL SELECT2: KHỞI TẠO 1 LẦN, RESET VALUE ĐÚNG CÁCH, KHÔNG LẶP ---
  // Khởi tạo select2 cho filter ngay từ đầu (chỉ 1 lần)
  $filterOu.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select OU (Unit)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/unit',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) {
        return { results: data };
      },
      cache: true
    }
  });
  $filterTags.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select tag(s)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/tag',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) {
        return { results: data };
      },
      cache: true
    }
  });
  $filterContacts.select2({
    theme: 'bootstrap-5',
    placeholder: 'Select contact(s)',
    allowClear: true,
    width: '100%',
    dropdownParent: $filterModalContent,
    dropdownPosition: 'below',
    ajax: {
      url: '/organize/api/contact',
      dataType: 'json',
      delay: 250,
      data: function(params) { return { search: params.term }; },
      processResults: function(data) {
        return { results: data };
      },
      cache: true
    }
  });

  // Reset filter value đúng cách khi mở modal
  $('#filterRuleModal').on('shown.bs.modal', function() {
    // Reset OU
    $filterOu.val(null).trigger('change');
    // Reset Tags
    $filterTags.val(null).trigger('change');
    // Reset Contacts
    $filterContacts.val(null).trigger('change');
  });

  // Destroy select2 when modal closes to avoid duplicate init
  $('#addRuleModal').on('hidden.bs.modal', function() {
    // Remove aria-hidden if still present (fixes focus warning)
    $(this).removeAttr('aria-hidden');
    if ($('#ruleOuId').hasClass('select2-hidden-accessible')) $('#ruleOuId').select2('destroy');
    if ($('#ruleTags').hasClass('select2-hidden-accessible')) $('#ruleTags').select2('destroy');
    if ($('#ruleContacts').hasClass('select2-hidden-accessible')) $('#ruleContacts').select2('destroy');
  });

  // Init select2 when modal opens, so dropdownParent is always correct
  $('#addRuleModal').on('shown.bs.modal', function() {
    // --- DEBUG: Confirm jQuery and select2 loaded ---
    if (typeof $ === 'undefined') {
      console.error('jQuery ($) is NOT loaded!');
    } else {
    }
    if (typeof $.fn.select2 === 'undefined') {
      console.error('select2 is NOT loaded!');
    } else {
    }
    var $modalContent = $('#addRuleModal .modal-content');
    if ($('#ruleOuId').hasClass('select2-hidden-accessible')) $('#ruleOuId').select2('destroy');
    if ($('#ruleTags').hasClass('select2-hidden-accessible')) $('#ruleTags').select2('destroy');
    if ($('#ruleContacts').hasClass('select2-hidden-accessible')) $('#ruleContacts').select2('destroy');
    $('#ruleOuId').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select OU (Unit)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/unit',
        dataType: 'json',
        delay: 250,
        data: function(params) {
          return { search: params.term };
        },
        processResults: function(data) {
          return { results: data };
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error('[AddRule Select2 OU] AJAX ERROR:', textStatus, errorThrown);
        },
        cache: true
      }
    });
    $('#ruleTags').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: function(params) {
          return { search: params.term };
        },
        processResults: function(data) {
          // Accept both [{id, name}] and [{id, text}] formats
          if (Array.isArray(data)) {
            return { results: data.map(tag => {
              if (tag.text) return tag;
              return { id: tag.id, text: tag.name };
            }) };
          }
          return { results: [] };
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error('[AddRule Select2 Tags] AJAX ERROR:', textStatus, errorThrown);
        },
        cache: true
      }
    });
    // Auto-select tags if provided from controller (selectedTags: [{id, name}])
    <% if (typeof selectedTags !== 'undefined' && Array.isArray(selectedTags) && selectedTags.length > 0) { %>
      var selectedTags = <%- JSON.stringify(selectedTags) %>;
      selectedTags.forEach(function(tag) {
        var option = new Option(tag.name, tag.id, true, true);
        $('#ruleTags').append(option).trigger('change');
      });
    <% } %>
    $('#ruleContacts').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: function(params) {
          return { search: params.term };
        },
        processResults: function(data) {
          // Accept both [{id, name}] and [{id, text}] formats
          if (Array.isArray(data)) {
            return { results: data.map(c => {
              if (c.text) return c;
              return { id: c.id, text: c.name + (c.email ? ' (' + c.email + ')' : '') };
            }) };
          }
          return { results: [] };
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error('[AddRule Select2 Contacts] AJAX ERROR:', textStatus, errorThrown);
        },
        cache: true
      }
    });
    // Tự động trigger tìm kiếm rỗng cho OU, Tags, Contacts khi mở modal
    setTimeout(function() {
      $('#ruleOuId').select2('open');
      $('#ruleOuId').select2('close');
      $('#ruleTags').select2('open');
      $('#ruleTags').select2('close');
      $('#ruleContacts').select2('open');
      $('#ruleContacts').select2('close');
    }, 300);
  });
  <% ruleList.forEach(function(rule) { %>
    $('#ruleEditModal-<%= rule.id %>').on('shown.bs.modal', function() {
      var $modalContent = $('#ruleEditModal-<%= rule.id %> .modal-content');
      var $ou = $('#editRuleOuId-<%= rule.id %>');
      var $tags = $('#editRuleTags-<%= rule.id %>');
      var $contacts = $('#editRuleContacts-<%= rule.id %>');
      if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
      if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
      if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
      // Xóa hết các option cũ trước khi append mới
      $ou.empty();
      $tags.empty();
      $contacts.empty();
      $ou.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select OU (Unit)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/unit',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      $tags.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select tag(s)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/tag',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      $contacts.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select contact(s)',
        allowClear: true,
        width: '100%',
        dropdownParent: $modalContent,
        dropdownPosition: 'below',
        ajax: {
          url: '/organize/api/contact',
          dataType: 'json',
          delay: 250,
          data: function(params) { return { search: params.term }; },
          processResults: function(data) { return { results: data }; },
          cache: true
        }
      });
      // Pre-select OU if present
      if (<%= rule.ou_id ? 'true' : 'false' %>) {
        var ouOption = new Option('<%= rule.ou_name || '' %>', '<%= rule.ou_id %>', true, true);
        $ou.append(ouOption).trigger('change');
      }
      // Pre-select tags if present
      var tagData = <%- JSON.stringify((rule.tags || []).map(t => t.id !== undefined ? t.id : t)) %>;
      var tagNames = <%- JSON.stringify((rule.tags || []).map(t => t.name || t)) %>;
      if (tagData.length > 0) {
        tagData.forEach(function(tid, i) {
          var tagOption = new Option(tagNames[i] || tid, tid, true, true);
          $tags.append(tagOption).trigger('change');
        });
      }
      // Pre-select contacts if present
      var contactData = <%- JSON.stringify(rule.contacts || []) %>;
      if (contactData.length > 0) {
        contactData.forEach(function(c) {
          var label = c.name + (c.email ? ' (' + c.email + ')' : '');
          var contactOption = new Option(label, c.id, true, true);
          $contacts.append(contactOption).trigger('change');
        });
      }
    });
    // Destroy select2 on modal close
    $('#ruleEditModal-<%= rule.id %>').on('hidden.bs.modal', function() {
      var $ou = $('#editRuleOuId-<%= rule.id %>');
      var $tags = $('#editRuleTags-<%= rule.id %>');
      var $contacts = $('#editRuleContacts-<%= rule.id %>');
      if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
      if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
      if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
    });
  <% }) %>
  // Init select2 for filter modal
  $('#filterRuleModal').on('shown.bs.modal', function() {
    var $modalContent = $('#filterRuleModal .modal-content');
    var $ou = $('#filterRuleOuId');
    var $tags = $('#filterRuleTags');
    var $contacts = $('#filterRuleContacts');
    if ($ou.hasClass('select2-hidden-accessible')) $ou.select2('destroy');
    if ($tags.hasClass('select2-hidden-accessible')) $tags.select2('destroy');
    if ($contacts.hasClass('select2-hidden-accessible')) $contacts.select2('destroy');
    $ou.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select OU (Unit)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/unit',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $tags.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    $contacts.select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contact(s)',
      allowClear: true,
      width: '100%',
      dropdownParent: $modalContent,
      dropdownPosition: 'below',
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: function(params) { return { search: params.term }; },
        processResults: function(data) { return { results: data }; },
        cache: true
      }
    });
    // --- Persist filter values ---
    <% if (typeof filterUnitId !== 'undefined' && filterUnitId) { %>
      var ouOption = new Option('<%= typeof selectedUnit !== 'undefined' ? selectedUnit : '' %>', '<%= filterUnitId %>', true, true);
      $ou.append(ouOption).trigger('change');
    <% } %>
    <% if (typeof filterTagIds !== 'undefined' && Array.isArray(filterTagIds) && filterTagIds.length > 0) { %>
      var tagData = <%- JSON.stringify(filterTagIds) %>;
      var tagNames = <%- JSON.stringify(typeof selectedTags !== 'undefined' ? selectedTags : []) %>;
      tagData.forEach(function(tid, i) {
        var tagOption = new Option(tagNames[i] || tid, tid, true, true);
        $tags.append(tagOption).trigger('change');
      });
    <% } %>
    <% if (typeof filterContactIds !== 'undefined' && Array.isArray(filterContactIds) && filterContactIds.length > 0) { %>
      var contactData = <%- JSON.stringify(filterContactIds) %>;
      var contactNames = <%- JSON.stringify(typeof selectedContacts !== 'undefined' ? selectedContacts : []) %>;
      contactData.forEach(function(cid, i) {
        var contactOption = new Option(contactNames[i] || cid, cid, true, true);
        $contacts.append(contactOption).trigger('change');
      });
    <% } %>
  });
  // Button to clear all filters
  $('#clearAllFilterBtn').on('click', function() {
    // Redirect to clean URL but preserve pageSize and search
    const currentPageSize = $('select[name="pageSize"]').val() || '10';
    const currentSearch = $('input[name="search"]').val() || '';
    let cleanUrl = '/firewall/rule';
    const params = [];
    if (currentPageSize && currentPageSize !== '10') params.push('pageSize=' + encodeURIComponent(currentPageSize));
    if (currentSearch) params.push('search=' + encodeURIComponent(currentSearch));
    if (params.length > 0) cleanUrl += '?' + params.join('&');
    window.location.href = cleanUrl;
  });
  // Select all rules functionality
  $('#selectAllRules').on('change', function() {
    $('.rule-checkbox').prop('checked', this.checked);
  });

  // If one checkbox is unchecked, uncheck selectAllRules
  $(document).on('change', '.rule-checkbox', function() {
    if (!this.checked) {
      $('#selectAllRules').prop('checked', false);
    } else if ($('.rule-checkbox:checked').length === $('.rule-checkbox').length) {
      $('#selectAllRules').prop('checked', true);
    }
  });

  // Handle Edit WO button
  $('#editMultiWOButton').on('click', function() {
    var checked = $('.rule-checkbox:checked');
    if (checked.length === 0) {
      $('#editWoWarning').removeClass('d-none');
      setTimeout(function() { $('#editWoWarning').addClass('d-none'); }, 2000);
    } else {
      $('#editWoModal').modal('show');
    }
  });
  // Show alert in the same position and style as single rule edit, centered below the button row
  function showWoAlert(message, type) {
    var $container = $('#wo-alert-container');
    $container.html(
      '<div class="alert alert-' + (type === 'success' ? 'success' : 'danger') + ' alert-dismissible fade show" role="alert" style="position:absolute; left:0; right:0; top:40px; margin:auto; z-index:9999; min-width:220px; max-width:400px; text-align:center;">'
      + message +
      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
      '</div>'
    );
    setTimeout(function() {
      $container.find('.alert').alert('close');
    }, 1200);
    $container.find('.alert').on('closed.bs.alert', function() {
      $container.empty();
      location.reload();
    });
  }
  // Handle Save button for batch WO
  $('#saveWoBtn').on('click', function() {
    var selectedIds = $('.rule-checkbox:checked').map(function() { return $(this).val(); }).get();
    var woValue = $('#woInput').val().trim();
    if (!woValue) {
      $('#woInput').addClass('is-invalid');
      if ($('#woInput').next('.invalid-feedback').length === 0) {
        $('#woInput').after('<div class="invalid-feedback">Work Order is required.</div>');
      }
      return;
    } else {
      $('#woInput').removeClass('is-invalid');
      $('#woInput').next('.invalid-feedback').remove();
    }
    $.ajax({
      url: '/firewall/api/batch-update-wo',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ ids: selectedIds, work_order: woValue }),
      success: function(res) {
        $('#editWoModal').modal('hide');
        // Truyền thông báo thành công qua query string để đồng bộ alert (KHÔNG encode)
        var url = new URL(window.location.href);
        url.searchParams.set('success', res.message || 'Work Order updated successfully!');
        window.location.href = url.toString();
      },
      error: function(xhr) {
        let msg = 'Update failed!';
        if (xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
        $('#editWoModal').modal('hide');
        // Truyền thông báo lỗi qua query string để đồng bộ alert (KHÔNG encode)
        var url = new URL(window.location.href);
        url.searchParams.set('error', msg);
        window.location.href = url.toString();
      }
    });
  });

  // Hiển thị alert thành công/thất bại từ query string (nếu có) sau khi reload trang (batch WO)
  var params = new URLSearchParams(window.location.search);
  if (params.has('success')) {
    var msg = params.get('success');
    var $alert = $('<div id="toast-success" class="toast-success alert alert-success" style="position:absolute; left:0; right:0; top:40px; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">'+msg+'</div>');
    $('#wo-alert-container').html($alert);
    setTimeout(function(){ $alert.fadeOut(400, function(){ $alert.remove(); }); }, 3000);
    params.delete('success');
    window.history.replaceState({}, '', window.location.pathname + (params.toString() ? '?' + params.toString() : ''));
  }
  if (params.has('error')) {
    var msg = params.get('error');
    var $alert = $('<div id="toast-error" class="toast-error alert alert-danger" style="position:absolute; left:0; right:0; top:0; margin:auto; z-index:9999; min-width:200px; max-width:400px; text-align:center;">'+msg+'</div>');
    $('#wo-alert-container').html($alert);
    setTimeout(function(){ $alert.fadeOut(400, function(){ $alert.remove(); }); }, 3000);
    params.delete('error');
    window.history.replaceState({}, '', window.location.pathname + (params.toString() ? '?' + params.toString() : ''));
  }
});
</script>
<!-- END SCRIPT -->

<script src="/vendor/jquery-3.6.0.min.js"></script>
<link href="/vendor/select2.min.css" rel="stylesheet" />
<link href="/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="/vendor/select2.min.js"></script>
<script src="/vendor/bootstrap.min.js"></script>
<link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css" />
