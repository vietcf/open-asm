<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-end align-items-center" style="margin-top: 16px;">
      <% if (hasPermission('configuration.create')) { %>
      <button type="button" class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addConfigModal">
        <i class="bi bi-plus"></i> Add Configuration
      </button>
      <% } %>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title mb-0">System Configuration</h3>
        </div>
        <div class="card-body table-responsive p-0">
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>No.</th>
                <th>Key</th>
                <th>Value</th>
                <th>Description</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (configList && configList.length > 0) { %>
                <% configList.forEach(function(config, idx) { %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td><%= config.key %></td>
                    <td>
                      <% if (typeof config.value === 'string' && config.value.length > 80) { %>
                        <%= config.value.substring(0, 80) %>...
                      <% } else { %>
                        <%= config.value %>
                      <% } %>
                    </td>
                    <td><%= config.description %></td>
                    <td class="text-end">
                      <a href="#" class="btn btn-info btn-sm" title="Show" data-bs-toggle="modal" data-bs-target="#configShowModal-<%= config.key %>"><i class="bi bi-eye"></i></a>
                      <% if (hasPermission('configuration.update')) { %>
                      <button type="button" class="btn btn-warning btn-sm" title="Edit" data-bs-toggle="modal" data-bs-target="#configEditModal-<%= config.key %>"><i class="bi bi-pencil"></i></button>
                      <% } %>
                      <% /*
                      if (hasPermission('configuration.delete')) { %>
                      <form action="/administrator/configuration/<%= config.key %>" method="POST" style="display:inline">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn btn-danger btn-sm" title="Delete" onclick="return confirm('Are you sure you want to delete this configuration?')"><i class="bi bi-trash"></i></button>
                      </form>
                      <% } */ %>
                    </td>
                  </tr>
                  <!-- Show Modal -->
                  <div class="modal fade" id="configShowModal-<%= config.key %>" tabindex="-1" aria-labelledby="configShowModalLabel-<%= config.key %>" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="configShowModalLabel-<%= config.key %>">Configuration Detail</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <dl class="row mb-0">
                            <dt class="col-sm-4">Key</dt>
                            <dd class="col-sm-8"><%= config.key %></dd>
                            <dt class="col-sm-4">Value</dt>
                            <dd class="col-sm-8">
                              <% let parsed = null; let isJson = false;
                                 try { parsed = JSON.parse(config.value); isJson = true; } catch(e) { isJson = false; }
                              %>
                              <% if (isJson) { %>
                                <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all; background: #f8f9fa; border-radius: 4px; padding: 8px;">
<%= JSON.stringify(parsed, null, 2) %>
                                </pre>
                              <% } else { %>
                                <%= config.value %>
                              <% } %>
                            </dd>
                            <dt class="col-sm-4">Description</dt>
                            <dd class="col-sm-8"><%= config.description || '' %></dd>
                          </dl>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Edit Modal -->
                  <% if (hasPermission('configuration.update')) { %>
                  <div class="modal fade" id="configEditModal-<%= config.key %>" tabindex="-1" aria-labelledby="configEditModalLabel-<%= config.key %>" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="/administrator/configuration/<%= config.key %>" method="POST">
                          <input type="hidden" name="key" value="<%= config.key %>">
                          <div class="modal-header">
                            <h5 class="modal-title" id="configEditModalLabel-<%= config.key %>">Edit Configuration</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label">Key</label>
                              <input type="text" class="form-control form-control-sm" name="key_display" value="<%= config.key %>" readonly>
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Value <span class="text-danger">*</span></label>
                              <textarea class="form-control form-control-sm" name="value" rows="4" required><%= config.value %></textarea>
                              <div class="form-text">Bạn có thể nhập JSON hoặc nhiều dòng cho các cấu hình dạng danh sách.</div>
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Description</label>
                              <input type="text" class="form-control form-control-sm" name="description" value="<%= config.description || '' %>">
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <% } %>
                <% }) %>
              <% } else { %>
                <tr><td colspan="5" class="text-center">No configuration found</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Configuration Modal -->
  <% if (hasPermission('configuration.create')) { %>
  <div class="modal fade" id="addConfigModal" tabindex="-1" aria-labelledby="addConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="/administrator/configuration" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="addConfigModalLabel">Add Configuration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Key <span class="text-danger">*</span></label>
              <input type="text" name="key" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Value <span class="text-danger">*</span></label>
              <textarea name="value" class="form-control form-control-sm" rows="4" required placeholder='Nhập giá trị, ví dụ: [{ "value": "DC", "label": "Data Center DR" }, ...]'></textarea>
              <div class="form-text">Bạn có thể nhập JSON hoặc nhiều dòng cho các cấu hình dạng danh sách.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <input type="text" name="description" class="form-control form-control-sm">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <% } %>
</div>
<script>
function showToast(msg, type) {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type}`;
  toast.style.position = 'fixed';
  toast.style.top = '16px';
  toast.style.right = '16px';
  toast.style.zIndex = 9999;
  toast.style.minWidth = '200px';
  toast.innerText = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function validateConfigForm(form) {
  const key = form.key.value.trim();
  const value = form.value.value.trim();
  if (!key || !value) {
    showToast('Key and Value are required!', 'danger');
    return false;
  }
  if (key === 'page_size') {
    // List of numbers, comma separated, strictly ascending
    const sizes = value.split(',').map(v => v.trim());
    if (!sizes.length || sizes.some(v => !/^\d+$/.test(v))) {
      showToast('Page size must be a list of numbers, separated by commas.', 'danger');
      return false;
    }
    const nums = sizes.map(Number);
    for (let i = 1; i < nums.length; i++) {
      if (nums[i] <= nums[i-1]) {
        showToast('Page size values must be sorted in ascending order.', 'danger');
        return false;
      }
    }
  } else if (key === 'log_level') {
    const allowed = ['info','warning','critical'];
    if (!allowed.includes(value)) {
      showToast('Log level must be one of: info, warning, or critical.', 'danger');
      return false;
    }
  }
  return true;
}

// Gắn vào form add
const addForm = document.querySelector('#addConfigModal form');
if (addForm) {
  addForm.onsubmit = function(e) {
    if (!validateConfigForm(this)) {
      e.preventDefault();
    }
  };
}

// Gắn vào các form edit
const editForms = document.querySelectorAll('form[action="/administrator/configuration/update"]');
editForms.forEach(function(form) {
  form.onsubmit = function(e) {
    if (!validateConfigForm(this)) {
      e.preventDefault();
    }
  };
});
</script>
<% if (success) { %>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      showToast('<%= success %>', 'success');
    });
  </script>
<% } %>
<% if (error) { %>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      showToast('<%= error %>', 'danger');
    });
  </script>
<% } %>
