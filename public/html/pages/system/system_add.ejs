<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-7 col-md-9">
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Add System</h5>
        </div>
        <form action="/system/system/add" method="POST" enctype="multipart/form-data">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">System ID <span class="text-danger">*</span></label>
              <input type="text" name="system_id" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label">System Name <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Alias (comma separated)</label>
              <input type="text" name="alias" class="form-control form-control-sm">
            </div>
            <div class="mb-3">
              <label class="form-label">FQDN (comma separated, optional)</label>
              <input type="text" name="fqdn" class="form-control form-control-sm" placeholder="e.g. host1.example.com, host2.example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control form-control-sm" rows="5" placeholder="Please provide the following information: 1) What business functions/features does this system provide? 2) What components does the system include? 3) Who are the target users of this system?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Level</label>
              <select name="level" class="form-select form-select-sm">
                <option value="">-- Select Level --</option>
                <% if (typeof levelOptions !== 'undefined' && Array.isArray(levelOptions)) { %>
                  <% levelOptions.forEach(function(opt) { %>
                    <option value="<%= opt.id %>"><%= opt.text %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Department (Unit)</label>
              <select id="unit-select" name="department_id" class="form-control"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Domains</label>
              <select id="domain-select" name="domains[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Managers</label>
              <select id="manager-select" name="managers[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">IP Addresses</label>
              <div class="d-flex align-items-center gap-2">
                <select id="ip-select" name="ip_addresses[]" class="form-control flex-grow-1" multiple></select>
                <!-- Nếu muốn thêm nút Add IP, thêm vào đây -->
                <!-- <button type="button" class="btn btn-outline-success btn-sm" id="add-ip-btn" title="Add new IP"><i class="bi bi-plus-circle"></i> Add IP</button> -->
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Tags</label>
              <select id="tag-select" name="tags[]" class="form-control" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Scope user access</label>
              <select id="scope-select" name="scopes[]" class="form-control" multiple>
                <% if (scopeOptions && scopeOptions.length > 0) { %>
                  <% scopeOptions.forEach(option => { %>
                    <option value="<%= option.id %>"><%= option.text %></option>
                  <% }) %>
                <% } %>
              </select>
              <div class="form-text">Select applicable scopes for this system. Leave empty if no specific scope is defined.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">System Architecture</label>
              <select id="architecture-select" name="architecture[]" class="form-select" multiple>
                <% if (architectureOptions && architectureOptions.length > 0) { %>
                  <% architectureOptions.forEach(option => { %>
                    <option value="<%= option.id %>"><%= option.text %></option>
                  <% }) %>
                <% } %>
              </select>
              <div class="form-text">Select applicable architecture types for this system. Leave empty if no specific architecture is defined.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">System Documents</label>
              <input type="file" id="docs-upload" class="form-control form-control-sm" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.png,.jpg,.jpeg,.zip,.rar">
              <div id="selected-docs-list" class="form-text"></div>
              <input type="hidden" name="uploaded_docs" id="uploaded-docs-hidden">
            </div>
          </div>
          <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary btn-sm">Add System</button>
            <a href="/system/system" class="btn btn-outline-secondary btn-sm ms-2">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="/vendor/jquery-3.6.0.min.js"></script>
<link href="/vendor/select2.min.css" rel="stylesheet" />
<link href="/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="/vendor/select2.min.js"></script>
<script src="/vendor/bootstrap.min.js"></script>
<link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css" />
<script>
  $(function() {
    // Department (Unit) select2 AJAX
    $('#unit-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select department',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/unit',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#manager-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select contacts',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#ip-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select IP addresses',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/network/api/ip-addresses',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#tag-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#domain-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select domain(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/network/api/domain',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#scope-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select scopes (optional)',
      allowClear: true,
      width: '100%'
    });
    $('#architecture-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select architecture types (optional)',
      allowClear: true,
      width: '100%'
    });
    // Show selected file names for docs
    $("input[name='docs[]']").on('change', function() {
      var files = this.files;
      var html = '';
      if (files.length) {
        html = '<ul style="margin:0;padding-left:18px">';
        for (var i = 0; i < files.length; i++) {
          html += '<li>' + files[i].name + '</li>';
        }
        html += '</ul>';
      }
      $('#selected-docs-list').html(html);
    });
    // AJAX upload for docs
    window.uploadedDocs = [];
    $('#docs-upload').on('change', function(e) {
      const files = Array.from(this.files);
      if (!files.length) return;
      files.forEach(file => {
        const formData = new FormData();
        formData.append('file', file);
        $.ajax({
          url: '/api/upload',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          xhrFields: { withCredentials: true }, // Đảm bảo gửi cookie/session
          success: function(res) {
            if (res.success && res.files && res.files.length > 0) {
              const uploaded = res.files[0];
              window.uploadedDocs.push(uploaded);
              renderUploadedDocs();
            }
          },
          error: function() {
            alert('Upload failed!');
          }
        });
      });
      // Reset input so can re-upload same file if needed
      $(this).val('');
    });
    function renderUploadedDocs() {
      let html = '';
      if (window.uploadedDocs.length) {
        html = '<ul style="margin:0;padding-left:18px">';
        window.uploadedDocs.forEach((doc, idx) => {
          html += `<li>${doc.originalname} <a href="${doc.url}" target="_blank">[View]</a> <a href="#" data-idx="${idx}" class="remove-doc">&times;</a></li>`;
        });
        html += '</ul>';
      }
      $('#selected-docs-list').html(html);
      $('#uploaded-docs-hidden').val(JSON.stringify(window.uploadedDocs));
    }
    // Remove file from list
    $('#selected-docs-list').on('click', '.remove-doc', function(e) {
      e.preventDefault();
      const idx = $(this).data('idx');
      window.uploadedDocs.splice(idx, 1);
      renderUploadedDocs();
    });
  });
</script>
