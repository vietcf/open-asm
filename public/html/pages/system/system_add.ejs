<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-7 col-md-9">
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Add System</h5>
        </div>
        <form action="/system/system/add" method="POST" enctype="multipart/form-data">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">System ID <span class="text-danger">*</span></label>
              <input type="text" name="system_id" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label">System Name <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Alias (comma separated)</label>
              <input type="text" name="alias" class="form-control form-control-sm">
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control form-control-sm" rows="5" placeholder="Enter system description (optional)"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Level</label>
              <select name="level" class="form-select form-select-sm">
                <option value="">-- Select Level --</option>
                <% if (typeof levelOptions !== 'undefined' && Array.isArray(levelOptions)) { %>
                  <% levelOptions.forEach(function(opt) { %>
                    <option value="<%= opt.value %>"><%= opt.label %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Department (Unit)</label>
              <select name="department_id" class="form-select form-select-sm">
                <option value="">-- Select Department --</option>
                <% units.forEach(function(unit) { %>
                  <option value="<%= unit.id %>"><%= unit.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Domains</label>
              <select id="domain-select" name="domains[]" class="form-select form-select-sm" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Managers</label>
              <select id="manager-select" name="managers[]" class="form-select form-select-sm" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">IP Addresses</label>
              <select id="ip-select" name="ip_addresses[]" class="form-select form-select-sm" multiple>
                <!-- Option sẽ được load động bằng select2 ajax -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Tags</label>
              <select id="tag-select" name="tags[]" class="form-select form-select-sm" multiple></select>
            </div>
            <div class="mb-3">
              <label class="form-label">System Documents</label>
              <input type="file" id="docs-upload" class="form-control form-control-sm" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.png,.jpg,.jpeg,.zip,.rar">
              <div id="selected-docs-list" class="form-text"></div>
              <input type="hidden" name="uploaded_docs" id="uploaded-docs-hidden">
            </div>
          </div>
          <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary btn-sm">Add System</button>
            <a href="/system/system" class="btn btn-outline-secondary btn-sm ms-2">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script>
  $(function() {
    $('#manager-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select manager(s)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/organize/api/contact',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#ip-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select IP address(es)',
      width: '100%',
      allowClear: true,
      ajax: {
        url: '/network/api/ip-addresses',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#tag-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select tag(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/organize/api/tag',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    $('#domain-select').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select domain(s)',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/network/api/domain',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term }),
        processResults: data => ({ results: data }),
        cache: true
      }
    });
    // Show selected file names for docs
    $("input[name='docs[]']").on('change', function() {
      var files = this.files;
      var html = '';
      if (files.length) {
        html = '<ul style="margin:0;padding-left:18px">';
        for (var i = 0; i < files.length; i++) {
          html += '<li>' + files[i].name + '</li>';
        }
        html += '</ul>';
      }
      $('#selected-docs-list').html(html);
    });
    // AJAX upload for docs
    window.uploadedDocs = [];
    $('#docs-upload').on('change', function(e) {
      const files = Array.from(this.files);
      if (!files.length) return;
      files.forEach(file => {
        const formData = new FormData();
        formData.append('file', file);
        $.ajax({
          url: '/api/upload',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          xhrFields: { withCredentials: true }, // Đảm bảo gửi cookie/session
          success: function(res) {
            if (res.success && res.files && res.files.length > 0) {
              const uploaded = res.files[0];
              window.uploadedDocs.push(uploaded);
              renderUploadedDocs();
            }
          },
          error: function() {
            alert('Upload failed!');
          }
        });
      });
      // Reset input so can re-upload same file if needed
      $(this).val('');
    });
    function renderUploadedDocs() {
      let html = '';
      if (window.uploadedDocs.length) {
        html = '<ul style="margin:0;padding-left:18px">';
        window.uploadedDocs.forEach((doc, idx) => {
          html += `<li>${doc.originalname} <a href="${doc.url}" target="_blank">[View]</a> <a href="#" data-idx="${idx}" class="remove-doc">&times;</a></li>`;
        });
        html += '</ul>';
      }
      $('#selected-docs-list').html(html);
      $('#uploaded-docs-hidden').val(JSON.stringify(window.uploadedDocs));
    }
    // Remove file from list
    $('#selected-docs-list').on('click', '.remove-doc', function(e) {
      e.preventDefault();
      const idx = $(this).data('idx');
      window.uploadedDocs.splice(idx, 1);
      renderUploadedDocs();
    });
  });
</script>
